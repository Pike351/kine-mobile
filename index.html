<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ComptabilitÃ© KinÃ©</title>
 
 <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
 
 <style>
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }
 body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
 background: #f9fafb;
 color: #111827;
 }
 .header {
 background: #2563eb;
 background-image: 
 linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 50%),
 repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,0.02) 35px, rgba(255,255,255,0.02) 70px);
 color: white;
 padding: 1.5rem;
 position: relative;
 overflow: hidden;
 }
 .header::before {
 content: '';
 position: absolute;
 top: -50%;
 right: -10%;
 width: 600px;
 height: 600px;
 background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
 border-radius: 50%;
 }
 .header::after {
 content: '';
 position: absolute;
 bottom: -30%;
 left: -5%;
 width: 400px;
 height: 400px;
 background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%);
 border-radius: 50%;
 }
 .header h1 {
 font-size: 1.875rem;
 font-weight: bold;
 position: relative;
 z-index: 1;
 }
 .header p {
 color: #bfdbfe;
 margin-top: 0.5rem;
 position: relative;
 z-index: 1;
 }
 .container {
 max-width: 1280px;
 margin: 0 auto;
 padding: 1.5rem;
 }
 .alert-box {
 background: #fef3c7;
 border: 1px solid #fbbf24;
 border-radius: 0.5rem;
 padding: 1rem;
 margin-bottom: 1.5rem;
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .alert-box .title {
 font-weight: 600;
 color: #92400e;
 }
 .alert-box .desc {
 font-size: 0.875rem;
 color: #78350f;
 }
 .stats-grid {
 display: grid;
 grid-template-columns: repeat(4, 1fr);
 gap: 1rem;
 margin-bottom: 1.5rem;
 }
 .stat-card {
 background: white;
 padding: 1rem;
 border-radius: 0.5rem;
 box-shadow: 0 1px 3px rgba(0,0,0,0.1);
 }
 .stat-card .label {
 color: #6b7280;
 font-size: 0.875rem;
 }
 .stat-card .value {
 font-size: 1.5rem;
 font-weight: bold;
 margin-top: 0.25rem;
 }
 .tabs {
 background: white;
 border-radius: 0.5rem;
 box-shadow: 0 1px 3px rgba(0,0,0,0.1);
 margin-bottom: 1.5rem;
 overflow: hidden;
 }
 .tabs-header {
 display: flex;
 border-bottom: 1px solid #e5e7eb;
 overflow-x: auto;
 }
 .tab-button {
 padding: 1rem 1.5rem;
 border: none;
 background: none;
 cursor: pointer;
 font-weight: 500;
 color: #6b7280;
 border-bottom: 2px solid transparent;
 white-space: nowrap;
 transition: all 0.2s;
 }
 .tab-button.active {
 color: #2563eb;
 border-bottom-color: #2563eb;
 }
 .tab-button:hover {
 background: #f9fafb;
 }
 .content-box {
 background: white;
 border-radius: 0.5rem;
 box-shadow: 0 1px 3px rgba(0,0,0,0.1);
 padding: 1.5rem;
 }
 .content-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 1rem;
 }
 .content-header h2 {
 font-size: 1.5rem;
 font-weight: bold;
 }
 .button {
 padding: 0.5rem 1rem;
 border: none;
 border-radius: 0.5rem;
 cursor: pointer;
 font-weight: 500;
 display: inline-flex;
 align-items: center;
 gap: 0.5rem;
 transition: all 0.2s;
 }
 .button-primary {
 background: #2563eb;
 color: white;
 }
 .button-primary:hover {
 background: #1d4ed8;
 }
 .button-success {
 background: #16a34a;
 color: white;
 }
 .button-success:hover {
 background: #15803d;
 }
 .button-danger {
 background: #dc2626;
 color: white;
 }
 .button-danger:hover {
 background: #b91c1c;
 }
 .button-group {
 display: flex;
 gap: 0.5rem;
 }
 table {
 width: 100%;
 border-collapse: collapse;
 margin-top: 1rem;
 }
 thead {
 background: #f9fafb;
 }
 th {
 padding: 0.75rem 1rem;
 text-align: left;
 font-weight: 600;
 font-size: 0.875rem;
 color: #374151;
 }
 td {
 padding: 0.75rem 1rem;
 border-top: 1px solid #e5e7eb;
 }
 tr:hover {
 background: #f9fafb;
 }
 .badge {
 display: inline-block;
 padding: 0.25rem 0.75rem;
 border-radius: 0.25rem;
 font-size: 0.75rem;
 font-weight: 600;
 }
 .badge-green {
 background: #d1fae5;
 color: #065f46;
 }
 .badge-blue {
 background: #dbeafe;
 color: #1e40af;
 }
 .badge-orange {
 background: #fed7aa;
 color: #9a3412;
 }
 .badge-purple {
 background: #e9d5ff;
 color: #6b21a8;
 }
 .modal {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0,0,0,0.5);
 z-index: 1000;
 overflow-y: auto;
 padding: 1rem;
 }
 .modal.active {
 display: flex;
 align-items: flex-start;
 justify-content: center;
 }
 .modal-content {
 background: white;
 border-radius: 0.5rem;
 max-width: 42rem;
 width: 100%;
 margin: 2rem auto;
 padding: 1.5rem;
 }
 .modal-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 1rem;
 }
 .modal-header h3 {
 font-size: 1.25rem;
 font-weight: bold;
 }
 .close-button {
 background: none;
 border: none;
 font-size: 1.5rem;
 cursor: pointer;
 color: #6b7280;
 padding: 0;
 width: 2rem;
 height: 2rem;
 display: flex;
 align-items: center;
 justify-content: center;
 }
 .close-button:hover {
 color: #111827;
 }
 .form-group {
 margin-bottom: 1rem;
 }
 .form-label {
 display: block;
 font-weight: 600;
 margin-bottom: 0.5rem;
 font-size: 0.875rem;
 }
 .form-input, .form-select, .form-textarea {
 width: 100%;
 padding: 0.5rem 0.75rem;
 border: 1px solid #d1d5db;
 border-radius: 0.375rem;
 font-size: 1rem;
 }
 .form-input:focus, .form-select:focus, .form-textarea:focus {
 outline: none;
 border-color: #2563eb;
 box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
 }
 .form-checkbox {
 width: 1rem;
 height: 1rem;
 margin-right: 0.5rem;
 }
 .checkbox-label {
 display: flex;
 align-items: center;
 font-weight: 500;
 }
 .empty-state {
 text-align: center;
 padding: 3rem 1rem;
 color: #6b7280;
 }
 .section-box {
 background: #f3f4f6;
 padding: 0.75rem;
 border-radius: 0.5rem;
 margin-bottom: 1rem;
 }
 .section-box h4 {
 font-weight: bold;
 margin-bottom: 0.5rem;
 }
 .info-grid {
 display: grid;
 grid-template-columns: repeat(2, 1fr);
 gap: 1rem;
 }
 .info-box {
 background: #f9fafb;
 border: 1px solid #d1d5db;
 padding: 1rem;
 border-radius: 0.5rem;
 }
 .summary-box {
 background: #f0f9ff;
 padding: 1.5rem;
 border-radius: 0.5rem;
 margin-bottom: 1.5rem;
 }
 .summary-box h3 {
 font-weight: 600;
 margin-bottom: 0.5rem;
 }
 .summary-box .amount {
 font-size: 1.875rem;
 font-weight: bold;
 color: #2563eb;
 }
 .icon {
 width: 1.125rem;
 height: 1.125rem;
 display: inline-block;
 vertical-align: middle;
 }
 .action-button {
 background: none;
 border: none;
 cursor: pointer;
 padding: 0.25rem;
 color: inherit;
 }
 .action-button:hover {
 opacity: 0.7;
 }
 .acte-selector {
 border: 1px solid #d1d5db;
 border-radius: 0.5rem;
 max-height: 16rem;
 overflow-y: auto;
 }
 .acte-item {
 padding: 0.75rem;
 border-bottom: 1px solid #e5e7eb;
 cursor: pointer;
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .acte-item:hover {
 background: #f9fafb;
 }
 .acte-item.selected {
 background: #eff6ff;
 }
 .acte-item:last-child {
 border-bottom: none;
 }
 @media (max-width: 768px) {
 .stats-grid {
 grid-template-columns: repeat(2, 1fr);
 }
 
 .info-grid {
 grid-template-columns: 1fr;
 }
 }
 </style>
</head>
<body>
 <div class="header">
 <h1>ComptabilitÃ© KinÃ©</h1>
 <p>Gestion actes, factures et rÃ¨glements HAD</p>
 </div>
 <div class="container">
 <div class="alert-box">
 <div>
 <div class="title">ğŸ’¾ Sauvegarde</div>
 <div class="desc">Les donnÃ©es sont sauvegardÃ©es automatiquement dans votre navigateur</div>
 </div>
 <div class="button-group">
 <button class="button button-success" onclick="exportBackup()">TÃ©lÃ©charger</button>
 <button class="button button-primary" onclick="document.getElementById('importFile').click()">Restaurer</button>
 <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)">
 </div>
 </div>
 
 <!-- ===== SYNCHRONISATION FIREBASE ===== -->
 <div style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;">
 <h3 style="color: #92400e; margin-bottom: 0.75rem; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem;">
 ğŸ”¥ Synchronisation Firebase
 </h3>
 
 <div style="background: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
 <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Statut de connexion</div>
 <div id="firebaseStatus" style="font-size: 0.875rem; font-weight: 600; color: #059669;">â³ Connexion...</div>
 </div>
 
 <div style="background: white; padding: 0.75rem; border-radius: 8px; font-size: 0.75rem; color: #92400e; line-height: 1.6;">
 <strong>âš¡ Synchronisation automatique :</strong><br>
 â€¢ Patients crÃ©Ã©s ici â†’ Disponibles sur mobile instantanÃ©ment<br>
 â€¢ Actes saisis sur mobile â†’ Apparaissent ici en temps rÃ©el<br>
 â€¢ Aucune manipulation nÃ©cessaire, tout est automatique !
 </div>
 </div>
 
 <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
 <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">ğŸ“‹ Workflow de facturation</div>
 <div style="font-size: 0.875rem; color: #1e3a8a; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
 <span class="badge badge-orange">En attente</span>
 <span>â†’</span>
 <span class="badge badge-blue">FacturÃ©</span>
 <span>â†’</span>
 <span class="badge badge-green">RÃ©glÃ©</span>
 <span style="margin-left: 0.5rem;">| Enregistrez les rÃ¨glements HAD pour marquer les actes comme rÃ©glÃ©s</span>
 </div>
 </div>
 <div style="margin-bottom: 1rem;">
 <h3 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">ğŸ“… Mois en cours</h3>
 <div class="stats-grid">
 <div class="stat-card">
 <div class="label">Patients actifs</div>
 <div class="value" id="stat-patients-mois">0</div>
 </div>
 <div class="stat-card">
 <div class="label">Ã€ facturer</div>
 <div class="value" id="stat-attente-mois">0</div>
 </div>
 <div class="stat-card">
 <div class="label">Recettes</div>
 <div class="value" id="stat-recettes-mois">0â‚¬</div>
 </div>
 <div class="stat-card">
 <div class="label">DÃ©penses</div>
 <div class="value" id="stat-depenses-mois">0â‚¬</div>
 </div>
 </div>
 </div>
 <div style="margin-bottom: 1rem;">
 <h3 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">ğŸ“Š Cumul annuel (Year to Date)</h3>
 <div class="stats-grid">
 <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
 <div class="label">Patients traitÃ©s</div>
 <div class="value" id="stat-patients-ytd">0</div>
 </div>
 <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
 <div class="label">Actes rÃ©alisÃ©s</div>
 <div class="value" id="stat-actes-ytd">0</div>
 </div>
 <div class="stat-card" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
 <div class="label">Recettes totales</div>
 <div class="value" id="stat-recettes-ytd">0â‚¬</div>
 </div>
 <div class="stat-card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
 <div class="label">DÃ©penses totales</div>
 <div class="value" id="stat-depenses-ytd">0â‚¬</div>
 </div>
 </div>
 </div>
 <div class="tabs">
 <div class="tabs-header">
 <button class="tab-button active" onclick="switchTab('patients')">Patients</button>
 <button class="tab-button" onclick="switchTab('actes')">Actes</button>
 <button class="tab-button" onclick="switchTab('bilans')">Bilans</button>
 <button class="tab-button" onclick="switchTab('factures')">Factures</button>
 <button class="tab-button" onclick="switchTab('reglements')">RÃ¨glements</button>
 <button class="tab-button" onclick="switchTab('depenses')">DÃ©penses</button>
 <button class="tab-button" onclick="switchTab('2035')">2035</button>
 <button class="tab-button" onclick="switchTab('pamc')">PAMC</button>
 <button class="tab-button" onclick="switchTab('parametres')">âš™ï¸ ParamÃ¨tres</button>
 </div>
 </div>
 <div class="content-box">
 <div id="tab-content"></div>
 </div>
 </div>
 <!-- Modal -->
 <div id="modal" class="modal">
 <div class="modal-content">
 <div class="modal-header">
 <h3 id="modal-title">Modal</h3>
 <button class="close-button" onclick="closeModal()">Ã—</button>
 </div>
 <div id="modal-body"></div>
 </div>
 </div>
 <script>
 // ===== FIREBASE CONFIGURATION =====
 const firebaseConfig = {
     apiKey: "AIzaSyAjcec_H6NalogrNhEbGGOZRdMKZzNVVRs",
     authDomain: "kine-comptabilite.firebaseapp.com",
     databaseURL: "https://kine-comptabilite-default-rtdb.europe-west1.firebasedatabase.app",
     projectId: "kine-comptabilite",
     storageBucket: "kine-comptabilite.firebasestorage.app",
     messagingSenderId: "100093570082",
     appId: "1:100093570082:web:f62c3daccec7065745ae7b"
 };

 // Initialiser Firebase
 let firebaseApp, database, firebaseReady = false;
 
 try {
     firebaseApp = firebase.initializeApp(firebaseConfig);
     database = firebase.database();
     firebaseReady = true;
     console.log('âœ… Firebase connectÃ©');
     
     // Mettre Ã  jour le statut aprÃ¨s un court dÃ©lai (attendre que le DOM soit prÃªt)
     setTimeout(() => {
         const statusEl = document.getElementById('firebaseStatus');
         if (statusEl) {
             statusEl.innerHTML = 'ğŸŸ¢ ConnectÃ©';
             statusEl.style.color = '#059669';
         }
     }, 500);
 } catch (error) {
     console.error('âŒ Erreur Firebase:', error);
     
     setTimeout(() => {
         const statusEl = document.getElementById('firebaseStatus');
         if (statusEl) {
             statusEl.innerHTML = 'ğŸ”´ Erreur';
             statusEl.style.color = '#dc2626';
         }
     }, 500);
 }

 // Variables globales
 let appData = {
 patients: [],
 actes: [],
 bilans: [],
 factures: [],
 reglements: [],
 depenses: [],
 parametres: {
 typesActes: [
 { code: 'AMK 28', libelle: 'Bilan initial', montant: 61.88, montantDeplacement: 0, categorie: 'HAD' },
 { code: 'AMK 20', libelle: 'Bilan intermÃ©diaire', montant: 44.20, montantDeplacement: 0, categorie: 'HAD' },
 { code: 'AMK 15,5', libelle: 'SÃ©ance classique', montant: 34.25, montantDeplacement: 10.00, categorie: 'HAD' },
 { code: 'AMK 10', libelle: 'KinÃ© Respi', montant: 22.10, montantDeplacement: 10.00, categorie: 'HAD' },
 { code: 'AMK 20 + IFD', libelle: 'SÃ©ance RÃ©adom', montant: 48.20, montantDeplacement: 10.00, categorie: 'READOM' }
 ],
 indemniteDeplacement: {
 actif: true,
 montant: 2.50
 },
 structure: {
 nom: '',
 adresse: '',
 numero: '',
 email: ''
 },
 professionnel: {
 nom: '',
 prenom: '',
 numeroRPPS: '',
 adresseCabinet: ''
 }
 }
 };
 let currentTab = 'patients';
 let editingItem = null;
 let selectedActes = [];
 let currentPatientFilter = null;
 let showFacturesReglees = true; // true = toutes les factures, false = seulement non rÃ©glÃ©es
 let showPatientsInactifs = true; // true = tous les patients, false = seulement actifs
 let showActesRegles = true; // true = tous les actes, false = seulement non rÃ©glÃ©s
 const categoriesDepenses = [
 { value: 'vehicule', label: 'Frais de vÃ©hicule', ligne2035: 'BJ' },
 { value: 'local', label: 'Local professionnel', ligne2035: 'BF' },
 { value: 'fournitures', label: 'Fournitures', ligne2035: 'BM' },
 { value: 'assurances', label: 'Assurances', ligne2035: 'BP' },
 { value: 'formation', label: 'Formation', ligne2035: 'BT' },
 { value: 'cotisations', label: 'Cotisations sociales', ligne2035: 'CC' },
 { value: 'honoraires', label: 'Honoraires comptables', ligne2035: 'BS' },
 { value: 'telephone', label: 'TÃ©lÃ©phone et Internet', ligne2035: 'BL' },
 { value: 'petit_equipement', label: 'Petit Ã©quipement', ligne2035: 'BP' },
 { value: 'blanchissage', label: 'Blanchissage', ligne2035: 'BG' },
 { value: 'autres', label: 'Autres charges', ligne2035: 'BZ' }
 ];
 // Chargement des donnÃ©es
 function loadData() {
 const saved = localStorage.getItem('kineAppData');
 if (saved) {
 appData = JSON.parse(saved);
 
 // Initialiser les paramÃ¨tres si non prÃ©sents (compatibilitÃ© anciennes versions)
 if (!appData.parametres) {
 appData.parametres = {
 typesActes: [
 { code: 'AMK', libelle: 'Massage / Mobilisation', montant: 16.13 },
 { code: 'AMS', libelle: 'RÃ©Ã©ducation spÃ©cialisÃ©e', montant: 23.10 },
 { code: 'AMC', libelle: 'Consultation', montant: 30.00 }
 ],
 indemniteDeplacement: {
 actif: true,
 montant: 2.50
 }
 };
 }
 }
 updateStats();
 renderCurrentTab();
 
 // Charger donnÃ©es depuis Firebase
 if (firebaseReady) {
 loadFromFirebase();
 setupRealtimeListeners();
 updateFirebaseStatus();
 }
 }
 
 // ===== FIREBASE SYNC FUNCTIONS =====
 
 // Mettre Ã  jour le statut Firebase dans l'UI
 function updateFirebaseStatus() {
 const statusEl = document.getElementById('firebaseStatus');
 if (statusEl) {
 if (firebaseReady) {
 statusEl.innerHTML = 'ğŸŸ¢ ConnectÃ©';
 statusEl.style.color = '#059669';
 } else {
 statusEl.innerHTML = 'ğŸ”´ DÃ©connectÃ©';
 statusEl.style.color = '#dc2626';
 }
 }
 }
 
 // Nettoyer les patients en double
 function cleanupDuplicatePatients() {
 console.log('ğŸ§¹ DÃ©but nettoyage des doublons...');
 
 const seen = new Map(); // nom+prenom â†’ patient
 const toKeep = [];
 const duplicatesFound = [];
 
 appData.patients.forEach(patient => {
 const key = `${patient.nom}_${patient.prenom}`.toLowerCase();
 const existing = seen.get(key);
 
 if (!existing) {
 // Premier patient avec ce nom, on le garde
 seen.set(key, patient);
 toKeep.push(patient);
 } else {
 // Doublon dÃ©tectÃ©
 duplicatesFound.push(`${patient.nom} ${patient.prenom}`);
 console.log(`ğŸ” Doublon trouvÃ©: ${patient.nom} ${patient.prenom}`);
 
 // Si le nouveau a un ID Firebase et pas l'ancien, remplacer
 const newId = String(patient.id || '');
 const existingId = String(existing.id || '');
 
 if (newId.startsWith('-') && !existingId.startsWith('-')) {
 // Le nouveau est de Firebase, remplacer l'ancien
 console.log(`âœ… Conservation version Firebase: ${newId}`);
 const index = toKeep.findIndex(p => p === existing);
 if (index !== -1) {
 toKeep[index] = patient;
 seen.set(key, patient);
 }
 } else if (!newId.startsWith('-') && existingId.startsWith('-')) {
 // L'ancien est de Firebase, garder l'ancien
 console.log(`âœ… Conservation version Firebase existante: ${existingId}`);
 // Ne rien faire, on garde existing
 } else {
 // Les deux sont soit Firebase soit locaux, garder le premier
 console.log(`â„¹ï¸ Conservation premiÃ¨re version`);
 }
 }
 });
 
 const removed = appData.patients.length - toKeep.length;
 
 if (removed === 0) {
 alert('âœ… Aucun doublon trouvÃ© !\n\nVotre liste de patients est propre.');
 console.log('âœ… Aucun doublon trouvÃ©');
 return;
 }
 
 // Afficher les doublons trouvÃ©s
 const uniqueDuplicates = [...new Set(duplicatesFound)];
 const message = `ğŸ§¹ Doublons dÃ©tectÃ©s :\n\n${uniqueDuplicates.map(d => 'â€¢ ' + d).join('\n')}\n\n${removed} version(s) en double seront supprimÃ©es.\n${toKeep.length} patient(s) seront conservÃ©s.\n\nContinuer ?`;
 
 if (!confirm(message)) {
 console.log('âŒ Nettoyage annulÃ© par l\'utilisateur');
 return;
 }
 
 appData.patients = toKeep;
 saveData();
 
 alert(`âœ… Nettoyage terminÃ© !\n\n${removed} doublon(s) supprimÃ©(s)\n${toKeep.length} patient(s) conservÃ©(s)\n\nLa page va se recharger pour afficher les changements.`);
 console.log(`âœ… Nettoyage terminÃ©: ${removed} doublons supprimÃ©s`);
 
 // Recharger la page pour rafraÃ®chir l'affichage
 location.reload();
 }
 
 // RÃ©initialiser types d'actes par dÃ©faut
 function resetTypesActes() {
 const message = `ğŸ”„ RÃ©initialiser les types d'actes ?

Cet outil va :
â€¢ Supprimer tous vos types d'actes actuels
â€¢ CrÃ©er les 5 types par dÃ©faut (HAD + READOM)
â€¢ Avec les montants de dÃ©placement corrects
â€¢ Synchroniser vers Firebase immÃ©diatement

âš ï¸ Vos types d'actes personnalisÃ©s seront perdus.

Continuer ?`;
 
 if (!confirm(message)) {
 console.log('âŒ RÃ©initialisation annulÃ©e');
 return;
 }
 
 console.log('ğŸ”„ RÃ©initialisation types d\'actes...');
 
 // Types par dÃ©faut
 const typesParDefaut = [
 { code: 'AMK 28', libelle: 'Bilan initial', montant: 61.88, montantDeplacement: 0, categorie: 'HAD' },
 { code: 'AMK 20', libelle: 'Bilan intermÃ©diaire', montant: 44.20, montantDeplacement: 0, categorie: 'HAD' },
 { code: 'AMK 15,5', libelle: 'SÃ©ance classique', montant: 34.25, montantDeplacement: 10.00, categorie: 'HAD' },
 { code: 'AMK 10', libelle: 'KinÃ© Respi', montant: 22.10, montantDeplacement: 10.00, categorie: 'HAD' },
 { code: 'AMK 20 + IFD', libelle: 'SÃ©ance RÃ©adom', montant: 48.20, montantDeplacement: 10.00, categorie: 'READOM' }
 ];
 
 // Remplacer types d'actes
 appData.parametres.typesActes = typesParDefaut;
 saveData();
 
 console.log(`âœ… ${typesParDefaut.length} types d'actes rÃ©initialisÃ©s`);
 
 // Synchroniser vers Firebase
 if (firebaseReady) {
 syncTypesActesToFirebase();
 console.log('âœ… Synchronisation Firebase lancÃ©e');
 }
 
 alert(`âœ… Types d'actes rÃ©initialisÃ©s !

${typesParDefaut.length} types d'actes crÃ©Ã©s avec succÃ¨s :
â€¢ AMK 28 - Bilan initial (0â‚¬ dÃ©pl.)
â€¢ AMK 20 - Bilan intermÃ©diaire (0â‚¬ dÃ©pl.)
â€¢ AMK 15,5 - SÃ©ance classique (10â‚¬ dÃ©pl.)
â€¢ AMK 10 - KinÃ© Respi (10â‚¬ dÃ©pl.)
â€¢ AMK 20 + IFD - SÃ©ance RÃ©adom (10â‚¬ dÃ©pl.)

Synchronisation Firebase en cours...
La page va se recharger.`);
 
 // Recharger la page
 setTimeout(() => location.reload(), 1000);
 }
 
 // Charger patients et actes depuis Firebase
 function loadFromFirebase() {
 // Charger patients
 database.ref('patients').once('value', (snapshot) => {
 const data = snapshot.val();
 if (data) {
 // REMPLACER complÃ¨tement par les donnÃ©es Firebase (pas de fusion)
 appData.patients = Object.keys(data).map(key => ({
 id: key,
 ...data[key]
 }));
 
 saveData();
 console.log(`âœ… ${appData.patients.length} patients chargÃ©s depuis Firebase`);
 }
 });
 
 // Charger actes
 database.ref('actes').once('value', (snapshot) => {
 const data = snapshot.val();
 if (data) {
 // REMPLACER complÃ¨tement par les donnÃ©es Firebase (pas de fusion)
 appData.actes = Object.keys(data).map(key => ({
 id: key,
 ...data[key]
 }));
 
 saveData();
 console.log(`âœ… ${appData.actes.length} actes chargÃ©s depuis Firebase`);
 }
 });
 
 // Charger types d'actes
 database.ref('typesActes').once('value', (snapshot) => {
 const data = snapshot.val();
 if (data && Array.isArray(data) && data.length > 0) {
 appData.parametres.typesActes = data;
 saveData();
 console.log(`âœ… ${data.length} types d'actes chargÃ©s depuis Firebase`);
 } else {
 // PremiÃ¨re connexion : synchroniser les types d'actes par dÃ©faut vers Firebase
 console.log('ğŸ”µ PremiÃ¨re sync types actes vers Firebase');
 syncTypesActesToFirebase();
 }
 });
 }
 
 // Ã‰coute temps rÃ©el des changements
 function setupRealtimeListeners() {
 // Recharger pÃ©riodiquement les donnÃ©es depuis Firebase (toutes les 10 secondes)
 // Plus simple et plus fiable que child_added qui crÃ©ait des doublons
 setInterval(() => {
 if (!firebaseReady) return;
 
 // Recharger patients
 database.ref('patients').once('value', (snapshot) => {
 const data = snapshot.val();
 if (data) {
 const firebasePatients = Object.keys(data).map(key => ({
 id: key,
 ...data[key]
 }));
 
 // Seulement mettre Ã  jour si changement
 const currentIds = appData.patients.map(p => p.id).sort().join(',');
 const newIds = firebasePatients.map(p => p.id).sort().join(',');
 
 if (currentIds !== newIds) {
 appData.patients = firebasePatients;
 saveData();
 console.log(`ğŸ”„ ${firebasePatients.length} patients rechargÃ©s depuis Firebase`);
 }
 }
 });
 
 // Recharger actes
 database.ref('actes').once('value', (snapshot) => {
 const data = snapshot.val();
 if (data) {
 const firebaseActes = Object.keys(data).map(key => ({
 id: key,
 ...data[key]
 }));
 
 // Seulement mettre Ã  jour si changement
 const currentIds = appData.actes.map(a => a.id).sort().join(',');
 const newIds = firebaseActes.map(a => a.id).sort().join(',');
 
 if (currentIds !== newIds) {
 appData.actes = firebaseActes;
 saveData();
 console.log(`ğŸ”„ ${firebaseActes.length} actes rechargÃ©s depuis Firebase`);
 }
 }
 });
 }, 10000); // Toutes les 10 secondes
 
 // Ã‰couter modifications types d'actes
 database.ref('typesActes').on('value', (snapshot) => {
 const data = snapshot.val();
 if (data && Array.isArray(data) && data.length > 0) {
 const currentTypesStr = JSON.stringify(appData.parametres.typesActes);
 const newTypesStr = JSON.stringify(data);
 
 if (currentTypesStr !== newTypesStr) {
 appData.parametres.typesActes = data;
 saveData();
 console.log(`âœ… Types d'actes mis Ã  jour depuis Firebase (${data.length} types)`);
 }
 }
 });
 }
 
 // Synchroniser patient vers Firebase
 function syncPatientToFirebase(patient, callback) {
 if (!firebaseReady) {
 console.log('âš ï¸ Firebase non prÃªt, sync annulÃ©e');
 if (callback) callback(null);
 return;
 }
 
 try {
 // Convertir l'ID en string pour Ã©viter les erreurs
 const patientId = String(patient.id || '');
 
 // Si l'ID commence par '-' c'est un ID Firebase, on met Ã  jour
 // Si l'ID commence par 'temp_' c'est temporaire, on crÃ©e
 // Sinon c'est un ID local ancien, on crÃ©e
 
 if (patientId.startsWith('-')) {
 // DÃ©jÃ  un ID Firebase, mettre Ã  jour
 console.log('ğŸ”µ Mise Ã  jour patient Firebase:', patientId);
 database.ref('patients/' + patientId).set({
 nom: patient.nom,
 prenom: patient.prenom,
 telephone: patient.telephone || '',
 numeroSecuriteSociale: patient.numeroSecuriteSociale || patient.numSecu || '',
 dateNaissance: patient.dateNaissance || '',
 adresse: patient.adresse || '',
 actif: patient.actif !== false,
 mutuelle: patient.mutuelle || '',
 numeroMutuelle: patient.numeroMutuelle || ''
 }).then(() => {
 console.log(`âœ… Patient ${patient.nom} mis Ã  jour sur Firebase`);
 if (callback) callback(patientId);
 }).catch(error => {
 console.error('âŒ Erreur mise Ã  jour Firebase:', error);
 if (callback) callback(null);
 });
 } else {
 // CrÃ©er nouveau avec ID Firebase
 console.log('ğŸ”µ CrÃ©ation nouveau patient Firebase');
 const newRef = database.ref('patients').push();
 const firebaseId = newRef.key;
 
 newRef.set({
 nom: patient.nom,
 prenom: patient.prenom,
 telephone: patient.telephone || '',
 numeroSecuriteSociale: patient.numeroSecuriteSociale || patient.numSecu || '',
 dateNaissance: patient.dateNaissance || '',
 adresse: patient.adresse || '',
 actif: patient.actif !== false,
 mutuelle: patient.mutuelle || '',
 numeroMutuelle: patient.numeroMutuelle || ''
 }).then(() => {
 console.log(`âœ… Patient ${patient.nom} crÃ©Ã© sur Firebase avec ID: ${firebaseId}`);
 
 // Retourner l'ID Firebase via callback
 if (callback) {
 callback(firebaseId);
 }
 }).catch(error => {
 console.error('âŒ Erreur crÃ©ation Firebase:', error);
 if (callback) callback(null);
 });
 }
 } catch (error) {
 console.error('âŒ Erreur dans syncPatientToFirebase:', error);
 if (callback) callback(null);
 }
 }
 
 // Synchroniser types d'actes vers Firebase
 function syncTypesActesToFirebase() {
 if (!firebaseReady) {
 console.log('âš ï¸ Firebase non prÃªt, sync types actes annulÃ©e');
 return;
 }
 
 try {
 console.log('ğŸ”µ Synchronisation types d\'actes vers Firebase...');
 
 // Envoyer tous les types d'actes
 database.ref('typesActes').set(appData.parametres.typesActes).then(() => {
 console.log(`âœ… ${appData.parametres.typesActes.length} types d'actes synchronisÃ©s vers Firebase`);
 }).catch(error => {
 console.error('âŒ Erreur sync types actes Firebase:', error);
 });
 } catch (error) {
 console.error('âŒ Erreur dans syncTypesActesToFirebase:', error);
 }
 }
 
 // Sauvegarde des donnÃ©es
 function saveData() {
 localStorage.setItem('kineAppData', JSON.stringify(appData));
 updateStats();
 renderCurrentTab();
 }
 // Mise Ã  jour des statistiques
 function updateStats() {
 const now = new Date();
 const currentYear = now.getFullYear();
 const currentMonth = now.getMonth(); // 0-11
 
 // Fonction helper pour vÃ©rifier si une date est dans le mois en cours
 const isCurrentMonth = (dateStr) => {
 const date = new Date(dateStr);
 return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
 };
 
 // Fonction helper pour vÃ©rifier si une date est dans l'annÃ©e en cours
 const isCurrentYear = (dateStr) => {
 const date = new Date(dateStr);
 return date.getFullYear() === currentYear;
 };
 
 // === STATISTIQUES MOIS EN COURS ===
 
 // Patients actifs (ne dÃ©pend pas de la date)
 const patientsActifs = appData.patients.filter(p => p.actif !== false).length;
 document.getElementById('stat-patients-mois').textContent = patientsActifs;
 
 // Actes en attente (ne dÃ©pend pas de la date)
 const actesEnAttente = appData.actes.filter(a => a.statut === 'en_attente').length;
 document.getElementById('stat-attente-mois').textContent = actesEnAttente;
 
 // Recettes du mois en cours
 const recettesMois = appData.reglements
 .filter(r => isCurrentMonth(r.date))
 .reduce((sum, r) => sum + r.montantTotal, 0);
 document.getElementById('stat-recettes-mois').textContent = recettesMois.toFixed(0) + 'â‚¬';
 
 // DÃ©penses du mois en cours
 const depensesMois = appData.depenses
 .filter(d => isCurrentMonth(d.date))
 .reduce((sum, d) => sum + d.montant, 0);
 document.getElementById('stat-depenses-mois').textContent = depensesMois.toFixed(0) + 'â‚¬';
 
 // === STATISTIQUES YEAR TO DATE ===
 
 // Patients traitÃ©s dans l'annÃ©e (patients ayant au moins un acte cette annÃ©e)
 const patientsAvecActesYTD = new Set(
 appData.actes
 .filter(a => isCurrentYear(a.date))
 .map(a => a.patientId)
 );
 document.getElementById('stat-patients-ytd').textContent = patientsAvecActesYTD.size;
 
 // Actes rÃ©alisÃ©s dans l'annÃ©e
 const actesYTD = appData.actes.filter(a => isCurrentYear(a.date)).length;
 document.getElementById('stat-actes-ytd').textContent = actesYTD;
 
 // Recettes totales de l'annÃ©e
 const recettesYTD = appData.reglements
 .filter(r => isCurrentYear(r.date))
 .reduce((sum, r) => sum + r.montantTotal, 0);
 document.getElementById('stat-recettes-ytd').textContent = recettesYTD.toFixed(0) + 'â‚¬';
 
 // DÃ©penses totales de l'annÃ©e
 const depensesYTD = appData.depenses
 .filter(d => isCurrentYear(d.date))
 .reduce((sum, d) => sum + d.montant, 0);
 document.getElementById('stat-depenses-ytd').textContent = depensesYTD.toFixed(0) + 'â‚¬';
 }
 // Changement d'onglet
 function switchTab(tab) {
 currentTab = tab;
 
 // Mise Ã  jour des boutons
 document.querySelectorAll('.tab-button').forEach(btn => {
 btn.classList.remove('active');
 });
 event.target.classList.add('active');
 
 renderCurrentTab();
 }
 // Rendu de l'onglet actuel
 function renderCurrentTab() {
 const content = document.getElementById('tab-content');
 
 switch(currentTab) {
 case 'patients':
 renderPatients(content);
 break;
 case 'actes':
 renderActes(content);
 break;
 case 'bilans':
 renderBilans(content);
 break;
 case 'factures':
 renderFactures(content);
 break;
 case 'reglements':
 renderReglements(content);
 break;
 case 'depenses':
 renderDepenses(content);
 break;
 case '2035':
 render2035(content);
 break;
 case 'pamc':
 renderPAMC(content);
 break;
 case 'parametres':
 renderParametres(content);
 break;
 }
 }
 // Rendu des patients
 function renderPatients(container) {
 // Filtrer selon le mode d'affichage
 let patientsAffiches = appData.patients;
 if (!showPatientsInactifs) {
 patientsAffiches = appData.patients.filter(p => p.actif !== false);
 }
 
 // Trier : actifs en premier, puis inactifs
 const patientsTries = [...patientsAffiches].sort((a, b) => {
 const aActif = a.actif !== false; // true par dÃ©faut si non dÃ©fini
 const bActif = b.actif !== false;
 if (aActif === bActif) return 0;
 return aActif ? -1 : 1;
 });
 
 const totalPatients = appData.patients.length;
 const patientsActifs = appData.patients.filter(p => p.actif !== false).length;
 const patientsInactifs = totalPatients - patientsActifs;
 
 // Calculer les montants totaux
 const montantTotalRegle = appData.actes
 .filter(a => a.statut === 'regle')
 .reduce((sum, a) => sum + getActeMontantTotal(a), 0);
 const montantTotalEnAttente = appData.actes
 .filter(a => a.statut === 'facture')
 .reduce((sum, a) => sum + getActeMontantTotal(a), 0);
 
 container.innerHTML = `
 <div class="content-header">
 <h2>Patients</h2>
 <div class="button-group">
 <label class="checkbox-label" style="background: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #d1d5db; cursor: pointer;">
 <input type="checkbox" class="form-checkbox" ${showPatientsInactifs ? 'checked' : ''} onchange="togglePatientsInactifs()">
 <span>Afficher les patients inactifs (${patientsInactifs})</span>
 </label>
 <button class="button button-primary" onclick="openPatientModal()">
 <span>â•</span> Nouveau
 </button>
 </div>
 </div>
 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
 <div class="summary-box" style="background: #f0fdf4; border-left: 4px solid #16a34a;">
 <div style="font-size: 0.875rem; color: #15803d; font-weight: 500;">Montant rÃ©glÃ©</div>
 <div class="amount" style="color: #16a34a;">${montantTotalRegle.toFixed(2)} â‚¬</div>
 </div>
 <div class="summary-box" style="background: #fff7ed; border-left: 4px solid #f97316;">
 <div style="font-size: 0.875rem; color: #c2410c; font-weight: 500;">En attente de rÃ¨glement</div>
 <div class="amount" style="color: #f97316;">${montantTotalEnAttente.toFixed(2)} â‚¬</div>
 </div>
 <div class="summary-box" style="background: #eff6ff; border-left: 4px solid #2563eb;">
 <div style="font-size: 0.875rem; color: #1e40af; font-weight: 500;">Patients actifs</div>
 <div class="amount" style="color: #2563eb;">${patientsActifs}</div>
 </div>
 </div>
 ${patientsTries.length === 0 ?
 `<div class="empty-state">${showPatientsInactifs ? 'Aucun patient. Cliquez sur Nouveau pour commencer.' : 'Aucun patient actif.'}</div>` :
 '<table><thead><tr><th>Statut</th><th>Nom</th><th>PrÃ©nom</th><th>TÃ©lÃ©phone</th><th>NÂ° SÃ©cu</th><th>RÃ©glÃ©</th><th>En attente</th><th>Actions</th></tr></thead><tbody>' +
 patientsTries.map(p => {
 const actif = p.actif !== false;
 // VÃ©rifier si le patient a des actes non facturÃ©s
 const actesNonFactures = appData.actes.filter(a => a.patientId === p.id && a.statut === 'en_attente');
 const hasActesNonFactures = actesNonFactures.length > 0;
 
 // Calculer les montants
 const actesPatient = appData.actes.filter(a => a.patientId === p.id);
 const montantRegle = actesPatient
 .filter(a => a.statut === 'regle')
 .reduce((sum, a) => sum + getActeMontantTotal(a), 0);
 const montantEnAttente = actesPatient
 .filter(a => a.statut === 'facture')
 .reduce((sum, a) => sum + getActeMontantTotal(a), 0);
 
 return `
 <tr style="${!actif ? 'opacity: 0.6; background: #f9fafb;' : ''}">
 <td>
 <span class="badge ${actif ? 'badge-green' : 'badge-orange'}">${actif ? 'Actif' : 'Inactif'}</span>
 </td>
 <td>${p.nom}</td>
 <td>${p.prenom}</td>
 <td>${p.telephone || '-'}</td>
 <td>${p.numSecu || '-'}</td>
 <td><strong style="color: #16a34a;">${montantRegle > 0 ? montantRegle.toFixed(2) + 'â‚¬' : '-'}</strong></td>
 <td><strong style="color: ${montantEnAttente > 0 ? '#f97316' : '#6b7280'};">${montantEnAttente > 0 ? montantEnAttente.toFixed(2) + 'â‚¬' : '-'}</strong></td>
 <td>
 <button class="action-button" onclick="togglePatientActif(${p.id})" title="${actif ? 'DÃ©sactiver' : 'Activer'}" style="color: ${actif ? '#f97316' : '#16a34a'};">
 ${actif ? 'â¸ï¸' : 'â–¶ï¸'}
 </button>
 ${actif && hasActesNonFactures ? `<button class="action-button" onclick="createFactureForPatient(${p.id})" title="CrÃ©er facture HAD (${actesNonFactures.length} acte(s))" style="color: #9333ea;">ğŸ“¥</button>` : ''}
 ${actif ? `<button class="action-button" onclick="createBilanForPatient(${p.id})" title="CrÃ©er bilan" style="color: #16a34a;">ğŸ“‹</button>` : ''}
 ${p.adresse ? `<button class="action-button" onclick="navigateToPatient('${p.adresse.replace(/'/g, "\\'")}', 'maps')" title="Navigation Google Maps" style="color: #4285f4;">ğŸ—ºï¸</button>` : ''}
 ${p.adresse ? `<button class="action-button" onclick="navigateToPatient('${p.adresse.replace(/'/g, "\\'")}', 'waze')" title="Navigation Waze" style="color: #33ccff;">ğŸš—</button>` : ''}
 <button class="action-button" onclick="editPatient(${p.id})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deletePatient(${p.id})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `;
 }).join('') + '</tbody></table>'
 }
 `;
 }
 // Rendu des actes
 function renderActes(container) {
 // Filtrer selon le mode d'affichage
 let actesAffiches = appData.actes;
 if (!showActesRegles) {
 actesAffiches = appData.actes.filter(a => a.statut !== 'regle');
 }
 
 // Trier les actes par statut : en_attente, facture, regle
 const actesOrdonnes = [...actesAffiches].sort((a, b) => {
 const ordreStatut = { 'en_attente': 1, 'facture': 2, 'regle': 3 };
 const ordreA = ordreStatut[a.statut] || 999;
 const ordreB = ordreStatut[b.statut] || 999;
 
 if (ordreA !== ordreB) {
 return ordreA - ordreB;
 }
 // Si mÃªme statut, trier par date (plus rÃ©cent en premier)
 return b.date.localeCompare(a.date);
 });
 
 const totalActes = appData.actes.length;
 const actesRegles = appData.actes.filter(a => a.statut === 'regle').length;
 
 container.innerHTML = `
 <div class="content-header">
 <h2>Actes</h2>
 <div class="button-group">
 <label class="checkbox-label" style="background: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #d1d5db; cursor: pointer;">
 <input type="checkbox" class="form-checkbox" ${showActesRegles ? 'checked' : ''} onchange="toggleActesRegles()">
 <span>Afficher les actes rÃ©glÃ©s (${actesRegles})</span>
 </label>
 <button class="button" style="background: #7c3aed; color: white;" onclick="openActesMasseModal()">ğŸ“‹ Saisie en masse</button>
 <button class="button button-success" onclick="exportCSV('actes')">ğŸ“¥ Export</button>
 <button class="button button-primary" onclick="openActeModal()">â• Nouveau</button>
 </div>
 </div>
 ${actesOrdonnes.length === 0 ?
 `<div class="empty-state">${showActesRegles ? 'Aucun acte enregistrÃ©' : 'Aucun acte non rÃ©glÃ©'}</div>` :
 '<table><thead><tr><th>Date</th><th>Patient</th><th>Type</th><th>Bilan</th><th>Montant</th><th>Statut</th><th>Actions</th></tr></thead><tbody>' +
 actesOrdonnes.map(a => `
 <tr style="${a.statut === 'regle' ? 'opacity: 0.6;' : ''}">
 <td>${a.date}</td>
 <td>${getPatientName(a.patientId)}</td>
 <td>${a.typeActe}</td>
 <td>${a.bilan ? 'âœ“' : '-'}</td>
 <td>${a.montant.toFixed(2)}â‚¬</td>
 <td><span class="badge ${a.statut === 'regle' ? 'badge-green' : a.statut === 'facture' ? 'badge-blue' : 'badge-orange'}">${a.statut === 'regle' ? 'RÃ©glÃ©' : a.statut === 'facture' ? 'FacturÃ©' : 'En attente'}</span></td>
 <td>
 ${a.bilan ? `<button class="action-button" onclick="openBilanFromActe(${a.id})" style="color: #16a34a;">ğŸ“‹</button>` : ''}
 <button class="action-button" onclick="editActe(${a.id})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deleteActe(${a.id})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `).join('') + '</tbody></table>'
 }
 `;
 }
 // Rendu des bilans
 function renderBilans(container) {
 container.innerHTML = `
 <div class="content-header">
 <h2>Bilans</h2>
 </div>
 ${appData.bilans.length === 0 ?
 '<div class="empty-state">Aucun bilan. Cliquez sur l\'icÃ´ne bilan dans l\'onglet Patients ou Actes.</div>' :
 '<table><thead><tr><th>Date</th><th>Patient</th><th>Type</th><th>Diagnostic</th><th>Actions</th></tr></thead><tbody>' +
 appData.bilans.map(b => `
 <tr>
 <td>${b.date}</td>
 <td>${getPatientName(b.patientId)}</td>
 <td>
 ${b.typeInitial ? '<span class="badge badge-blue">Init.</span>' : ''}
 ${b.typeIntermediaire ? '<span class="badge badge-orange">Inter.</span>' : ''}
 ${b.typeFinale ? '<span class="badge badge-green">Final</span>' : ''}
 </td>
 <td>${(b.diagnostic || '-').substring(0, 50)}${b.diagnostic && b.diagnostic.length > 50 ? '...' : ''}</td>
 <td>
 <button class="action-button" onclick="printBilan(${b.id})" title="Imprimer" style="color: #16a34a;">ğŸ–¨ï¸</button>
 <button class="action-button" onclick="editBilan(${b.id})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deleteBilan(${b.id})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `).join('') + '</tbody></table>'
 }
 `;
 }
 // Rendu des factures
 function renderFactures(container) {
 // Fonction helper pour vÃ©rifier si une facture est rÃ©glÃ©e
 const isFactureReglee = (facture) => {
 const actesFacture = appData.actes.filter(a => facture.actesSelectionnes.includes(a.id));
 return actesFacture.every(a => a.statut === 'regle');
 };
 
 // Filtrer les factures selon le mode d'affichage
 let facturesAffichees = appData.factures;
 if (!showFacturesReglees) {
 facturesAffichees = appData.factures.filter(f => !isFactureReglee(f));
 }
 
 // Trier : factures non rÃ©glÃ©es en premier, puis rÃ©glÃ©es
 facturesAffichees = [...facturesAffichees].sort((a, b) => {
 const aReglee = isFactureReglee(a);
 const bReglee = isFactureReglee(b);
 
 if (aReglee === bReglee) {
 // MÃªme statut : trier par date dÃ©croissante
 return b.date.localeCompare(a.date);
 }
 // Factures non rÃ©glÃ©es en premier
 return aReglee ? 1 : -1;
 });
 
 const totalFactures = appData.factures.length;
 const facturesReglees = appData.factures.filter(f => isFactureReglee(f)).length;
 const facturesNonReglees = totalFactures - facturesReglees;
 
 container.innerHTML = `
 <div class="content-header">
 <h2>Factures HAD</h2>
 <div class="button-group">
 <label class="checkbox-label" style="background: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #d1d5db; cursor: pointer;">
 <input type="checkbox" class="form-checkbox" ${showFacturesReglees ? 'checked' : ''} onchange="toggleFacturesReglees()">
 <span>Afficher les factures rÃ©glÃ©es (${facturesReglees})</span>
 </label>
 <button class="button button-success" onclick="exportCSV('factures')">ğŸ“¥ Export</button>
 <button class="button button-primary" onclick="createNewFacture()">â• Nouvelle</button>
 </div>
 </div>
 ${facturesAffichees.length === 0 ?
 `<div class="empty-state">${showFacturesReglees ? 'Aucune facture' : 'Aucune facture non rÃ©glÃ©e'}</div>` :
 '<table><thead><tr><th>Date</th><th>NumÃ©ro</th><th>Patient</th><th>Montant</th><th>Actes</th><th>Statut</th><th>Actions</th></tr></thead><tbody>' +
 facturesAffichees.map(f => {
 // RÃ©cupÃ©rer les patients des actes de cette facture
 const actesFacture = appData.actes.filter(a => f.actesSelectionnes.includes(a.id));
 const patientsUniques = [...new Set(actesFacture.map(a => getPatientName(a.patientId)))];
 const patientDisplay = patientsUniques.length === 1 ? patientsUniques[0] : `${patientsUniques.length} patients`;
 const estReglee = isFactureReglee(f);
 
 return `
 <tr style="${estReglee ? 'opacity: 0.6;' : ''}">
 <td>${f.date}</td>
 <td>${f.numero}</td>
 <td>${patientDisplay}</td>
 <td>${f.montantTotal.toFixed(2)}â‚¬</td>
 <td>${f.actesSelectionnes.length}</td>
 <td>
 <span class="badge ${estReglee ? 'badge-green' : 'badge-orange'}">
 ${estReglee ? 'âœ“ RÃ©glÃ©e' : 'â³ En attente'}
 </span>
 </td>
 <td>
 <button class="action-button" onclick="downloadFactureHAD(${f.id})" title="TÃ©lÃ©charger facture" style="color: #9333ea;">ğŸ“¥</button>
 <button class="action-button" onclick="sendFactureByEmail(${f.id})" title="Envoyer par email" style="color: #16a34a;">ğŸ“§</button>
 <button class="action-button" onclick="editFacture(${f.id})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deleteFacture(${f.id})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `;
 }).join('') + '</tbody></table>'
 }
 `;
 }
 // Rendu des rÃ¨glements
 function renderReglements(container) {
 container.innerHTML = `
 <div class="content-header">
 <h2>RÃ¨glements HAD</h2>
 <div class="button-group">
 <button class="button button-success" onclick="exportCSV('reglements')">ğŸ“¥ Export</button>
 <button class="button button-primary" onclick="openReglementModal()">â• Nouveau</button>
 </div>
 </div>
 ${appData.reglements.length === 0 ?
 '<div class="empty-state">Aucun rÃ¨glement</div>' :
 '<table><thead><tr><th>Date</th><th>PÃ©riode</th><th>Montant</th><th>Patients</th><th>Actions</th></tr></thead><tbody>' +
 appData.reglements.map(r => {
 // RÃ©cupÃ©rer les patients des actes de ce rÃ¨glement
 const actesReglement = appData.actes.filter(a => r.actesSelectionnes.includes(a.id));
 const patientsUniques = [...new Set(actesReglement.map(a => getPatientName(a.patientId)))];
 const patientDisplay = patientsUniques.length === 1 
 ? patientsUniques[0] 
 : `${patientsUniques.length} patients (${actesReglement.length} actes)`;
 
 return `
 <tr>
 <td>${r.date}</td>
 <td>${r.periode}</td>
 <td><strong style="color: #16a34a;">${r.montantTotal.toFixed(2)}â‚¬</strong></td>
 <td>${patientDisplay}</td>
 <td>
 <button class="action-button" onclick="viewReglementDetails(${r.id})" title="Voir le dÃ©tail" style="color: #7c3aed;">ğŸ‘ï¸</button>
 <button class="action-button" onclick="editReglement(${r.id})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deleteReglement(${r.id})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `;
 }).join('') + '</tbody></table>'
 }
 `;
 }
 // Rendu des dÃ©penses
 function renderDepenses(container) {
 container.innerHTML = `
 <div class="content-header">
 <h2>DÃ©penses</h2>
 <button class="button button-primary" onclick="openDepenseModal()">â• Nouveau</button>
 </div>
 ${appData.depenses.length === 0 ?
 '<div class="empty-state">Aucune dÃ©pense</div>' :
 '<table><thead><tr><th>Date</th><th>CatÃ©gorie</th><th>Description</th><th>Montant</th><th>Actions</th></tr></thead><tbody>' +
 appData.depenses.map(d => `
 <tr>
 <td>${d.date}</td>
 <td>${categoriesDepenses.find(c => c.value === d.categorie)?.label || d.categorie}</td>
 <td>${d.description}</td>
 <td>${d.montant.toFixed(2)}â‚¬</td>
 <td>
 <button class="action-button" onclick="editDepense(${d.id})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deleteDepense(${d.id})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `).join('') + '</tbody></table>'
 }
 `;
 }
 // Rendu 2035
 function render2035(container) {
 const totalRecettes = appData.reglements.reduce((sum, r) => sum + r.montantTotal, 0);
 const totalDepenses = appData.depenses.reduce((sum, d) => sum + d.montant, 0);
 const benefice = totalRecettes - totalDepenses;
 
 // Ventilation des dÃ©penses par catÃ©gorie
 const ventilationDepenses = {};
 categoriesDepenses.forEach(cat => {
 ventilationDepenses[cat.value] = {
 label: cat.label,
 ligne: cat.ligne2035,
 montant: 0
 };
 });
 
 appData.depenses.forEach(d => {
 if (ventilationDepenses[d.categorie]) {
 ventilationDepenses[d.categorie].montant += d.montant;
 }
 });
 
 // Regroupement par ligne 2035 (certaines lignes peuvent avoir plusieurs catÃ©gories)
 const lignes2035 = {};
 Object.values(ventilationDepenses).forEach(v => {
 if (!lignes2035[v.ligne]) {
 lignes2035[v.ligne] = { montant: 0, categories: [] };
 }
 lignes2035[v.ligne].montant += v.montant;
 if (v.montant > 0) {
 lignes2035[v.ligne].categories.push(`${v.label}: ${v.montant.toFixed(2)}â‚¬`);
 }
 });
 
 container.innerHTML = `
 <div class="content-header">
 <h2>DÃ©claration 2035</h2>
 <button class="button button-success" onclick="exportCSV('2035')">ğŸ“¥ Export CSV</button>
 </div>
 
 <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 2rem; border-radius: 0.5rem;">
 <p style="margin: 0; font-size: 0.875rem; color: #78350f;">
 âš ï¸ <strong>Information importante</strong> : Cette ventilation est une aide pour prÃ©parer votre dÃ©claration 2035. 
 VÃ©rifiez toujours avec votre expert-comptable avant de dÃ©clarer.
 </p>
 </div>
 
 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
 <div class="summary-box" style="background: #eff6ff; border-left: 4px solid #2563eb;">
 <h3>Recettes (Ligne AA)</h3>
 <div class="amount" style="color: #2563eb;">${totalRecettes.toFixed(2)} â‚¬</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
 Honoraires rÃ©trocÃ©dÃ©s non compris
 </div>
 </div>
 <div class="summary-box" style="background: #fef2f2; border-left: 4px solid #dc2626;">
 <h3>DÃ©penses totales</h3>
 <div class="amount" style="color: #dc2626;">${totalDepenses.toFixed(2)} â‚¬</div>
 </div>
 <div class="summary-box" style="background: #f0fdf4; border-left: 4px solid #16a34a;">
 <h3>BÃ©nÃ©fice (Ligne CM)</h3>
 <div class="amount" style="color: #16a34a;">${benefice.toFixed(2)} â‚¬</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
 Avant cotisations sociales
 </div>
 </div>
 </div>
 
 <div class="section-box">
 <h3 style="margin-bottom: 1.5rem; color: #1f2937;">ğŸ“Š Ventilation des dÃ©penses par ligne 2035</h3>
 
 <div style="margin-bottom: 2rem;">
 <h4 style="margin-bottom: 1rem; color: #4b5563; font-size: 1rem;">I. FRAIS GÃ‰NÃ‰RAUX</h4>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Ligne</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 ${renderLigne2035('BF', 'Locations et charges locatives', lignes2035)}
 ${renderLigne2035('BG', 'Blanchissage, nettoyage', lignes2035)}
 ${renderLigne2035('BJ', 'Frais de vÃ©hicule', lignes2035)}
 ${renderLigne2035('BL', 'Frais de tÃ©lÃ©communication', lignes2035)}
 ${renderLigne2035('BM', 'Fournitures de bureau, documentation', lignes2035)}
 ${renderLigne2035('BP', 'Assurances, petit Ã©quipement', lignes2035)}
 ${renderLigne2035('BS', 'Honoraires (expert-comptable...)', lignes2035)}
 ${renderLigne2035('BT', 'Frais de formation', lignes2035)}
 ${renderLigne2035('BZ', 'Autres frais divers de gestion', lignes2035)}
 </tbody>
 </table>
 </div>
 
 <div style="margin-bottom: 2rem;">
 <h4 style="margin-bottom: 1rem; color: #4b5563; font-size: 1rem;">II. CHARGES SOCIALES</h4>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Ligne</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 ${renderLigne2035('CC', 'Cotisations sociales personnelles', lignes2035)}
 </tbody>
 </table>
 </div>
 
 <div style="background: #eff6ff; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #2563eb;">
 <div style="display: flex; justify-content: space-between; align-items: center;">
 <span style="font-weight: 600; color: #1e40af;">Total des dÃ©penses dÃ©ductibles</span>
 <span style="font-weight: 700; font-size: 1.25rem; color: #2563eb;">${totalDepenses.toFixed(2)} â‚¬</span>
 </div>
 </div>
 </div>
 
 <div class="section-box" style="margin-top: 2rem;">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“‹ DÃ©tail par catÃ©gorie de dÃ©pense</h3>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">CatÃ©gorie</th>
 <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Ligne 2035</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 ${categoriesDepenses.map(cat => {
 const montant = ventilationDepenses[cat.value].montant;
 return `
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem;">${cat.label}</td>
 <td style="padding: 0.75rem; text-align: center; font-family: monospace; font-weight: 600; color: #6b7280;">${cat.ligne2035}</td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${montant > 0 ? '#dc2626' : '#9ca3af'};">
 ${montant > 0 ? montant.toFixed(2) + ' â‚¬' : '-'}
 </td>
 </tr>
 `;
 }).join('')}
 <tr style="background: #fef2f2; font-weight: 700;">
 <td style="padding: 0.75rem;" colspan="2">TOTAL</td>
 <td style="padding: 0.75rem; text-align: right; color: #dc2626;">${totalDepenses.toFixed(2)} â‚¬</td>
 </tr>
 </tbody>
 </table>
 </div>
 `;
 }
 
 // Fonction helper pour afficher une ligne 2035
 function renderLigne2035(code, libelle, lignes) {
 const ligne = lignes[code];
 const montant = ligne ? ligne.montant : 0;
 const details = ligne && ligne.categories.length > 0 ? ligne.categories.join(' + ') : '';
 
 return `
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">${code}</td>
 <td style="padding: 0.75rem;">
 <div>${libelle}</div>
 ${details ? `<div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">${details}</div>` : ''}
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${montant > 0 ? '#dc2626' : '#d1d5db'};">
 ${montant > 0 ? montant.toFixed(2) + ' â‚¬' : '-'}
 </td>
 </tr>
 `;
 }
 // Rendu PAMC
 function renderPAMC(container) {
 const totalRecettes = appData.reglements.reduce((sum, r) => sum + r.montantTotal, 0);
 const totalDepenses = appData.depenses.reduce((sum, d) => sum + d.montant, 0);
 const benefice = totalRecettes - totalDepenses;
 
 // Ventilation des dÃ©penses par catÃ©gorie
 const ventilationDepenses = {};
 categoriesDepenses.forEach(cat => {
 ventilationDepenses[cat.value] = 0;
 });
 
 appData.depenses.forEach(d => {
 if (ventilationDepenses[d.categorie] !== undefined) {
 ventilationDepenses[d.categorie] += d.montant;
 }
 });
 
 // Calculs PAMC spÃ©cifiques
 const fraisVehicule = ventilationDepenses['vehicule'] || 0;
 const local = ventilationDepenses['local'] || 0;
 const fournitures = ventilationDepenses['fournitures'] || 0;
 const assurances = ventilationDepenses['assurances'] || 0;
 const formation = ventilationDepenses['formation'] || 0;
 const cotisationsSociales = ventilationDepenses['cotisations'] || 0;
 const honoraires = ventilationDepenses['honoraires'] || 0;
 const telephone = ventilationDepenses['telephone'] || 0;
 const petitEquipement = ventilationDepenses['petit_equipement'] || 0;
 const blanchissage = ventilationDepenses['blanchissage'] || 0;
 const autres = ventilationDepenses['autres'] || 0;
 
 // Total frais professionnels (hors cotisations sociales)
 const totalFraisPro = fraisVehicule + local + fournitures + assurances + formation + 
 honoraires + telephone + petitEquipement + blanchissage + autres;
 
 // BÃ©nÃ©fice avant cotisations
 const beneficeAvantCotisations = totalRecettes - totalFraisPro;
 
 // BÃ©nÃ©fice net (aprÃ¨s cotisations)
 const beneficeNet = beneficeAvantCotisations - cotisationsSociales;
 
 // Revenus nets aprÃ¨s cotisations facultatives (pour 2042)
 const cotisationsFacultatives = 0; // Ã€ implÃ©menter si besoin
 const revenuFiscal = beneficeNet - cotisationsFacultatives;
 const revenuSocial = beneficeAvantCotisations - cotisationsFacultatives;
 
 // Taux de charges (hors cotisations / recettes)
 const tauxCharges = totalRecettes > 0 ? (totalFraisPro / totalRecettes * 100) : 0;
 
 // Taux de cotisations
 const tauxCotisations = totalRecettes > 0 ? (cotisationsSociales / totalRecettes * 100) : 0;
 
 container.innerHTML = `
 <div class="content-header">
 <h2>ğŸ“‹ DÃ©claration 2042 PAMC</h2>
 <button class="button button-success" onclick="exportCSV('pamc')">ğŸ“¥ Export CSV</button>
 </div>
 
 <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 2rem; border-radius: 0.5rem;">
 <p style="margin: 0; font-size: 0.875rem; color: #78350f;">
 â„¹ï¸ <strong>PAMC - Praticien et Auxiliaire MÃ©dical ConventionnÃ©</strong><br>
 DÃ©claration 2042 PAMC avec codes officiels DS. Les montants sont calculÃ©s automatiquement depuis vos recettes et dÃ©penses.
 VÃ©rifiez toujours avec votre AGA (Association de Gestion AgrÃ©Ã©e) ou expert-comptable.
 </p>
 </div>
 
 <!-- SynthÃ¨se globale -->
 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
 <div class="summary-box" style="background: #eff6ff; border-left: 4px solid #2563eb;">
 <h3>Recettes brutes totales</h3>
 <div class="amount" style="color: #2563eb;">${totalRecettes.toFixed(2)} â‚¬</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Case DSCS / DSAV</div>
 </div>
 <div class="summary-box" style="background: #fff7ed; border-left: 4px solid #f97316;">
 <h3>Cotisations sociales</h3>
 <div class="amount" style="color: #f97316;">${cotisationsSociales.toFixed(2)} â‚¬</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Case DSCA</div>
 </div>
 <div class="summary-box" style="background: #f0fdf4; border-left: 4px solid #16a34a;">
 <h3>Revenus nets</h3>
 <div class="amount" style="color: #16a34a;">${beneficeNet.toFixed(2)} â‚¬</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Case DSGA (BÃ©nÃ©fice)</div>
 </div>
 <div class="summary-box" style="background: #fef2f2; border-left: 4px solid #dc2626;">
 <h3>Revenu fiscal 2042</h3>
 <div class="amount" style="color: #dc2626;">${revenuFiscal.toFixed(2)} â‚¬</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Case 5QC</div>
 </div>
 </div>
 
 <!-- Section 1 - DonnÃ©es CNAM -->
 <div class="section-box" style="margin-bottom: 2rem;">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š DONNÃ‰ES TRANSMISES PAR LA CNAM</h3>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Code</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSAV</td>
 <td style="padding: 0.75rem;">
 <div>Honoraires tirÃ©s d'actes conventionnÃ©s</div>
 <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Total des rÃ¨glements HAD encaissÃ©s</div>
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: #2563eb; font-size: 1.125rem;">
 ${totalRecettes.toFixed(2)} â‚¬
 </td>
 </tr>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSAW</td>
 <td style="padding: 0.75rem;">
 <div>DÃ©passements d'honoraires</div>
 <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Non applicable pour les kinÃ©sithÃ©rapeutes</div>
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #d1d5db;">
 0 â‚¬
 </td>
 </tr>
 <tr style="background: #eff6ff; font-weight: 700;">
 <td style="padding: 0.75rem; font-family: monospace;">DSCS</td>
 <td style="padding: 0.75rem;">Recettes brutes totales tirÃ©es des activitÃ©s non salariÃ©es</td>
 <td style="padding: 0.75rem; text-align: right; color: #2563eb; font-size: 1.125rem;">
 ${totalRecettes.toFixed(2)} â‚¬
 </td>
 </tr>
 </tbody>
 </table>
 </div>
 
 <!-- Section 2 - Cotisations sociales -->
 <div class="section-box" style="margin-bottom: 2rem;">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ¥ COTISATIONS SOCIALES OBLIGATOIRES</h3>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Code</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSCA</td>
 <td style="padding: 0.75rem;">
 <div>Cotisations sociales obligatoires dÃ©duites du rÃ©sultat imposable</div>
 <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">URSSAF, retraite CARPIMKO, prÃ©voyance, etc.</div>
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: #f97316; font-size: 1.125rem;">
 ${cotisationsSociales.toFixed(2)} â‚¬
 </td>
 </tr>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSDA</td>
 <td style="padding: 0.75rem;">
 <div>Cotisations sociales obligatoires "nÃ©gatives"</div>
 <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Remboursements de trop-perÃ§u</div>
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #d1d5db;">
 -
 </td>
 </tr>
 </tbody>
 </table>
 </div>
 
 <!-- Section 3 - Cotisations facultatives -->
 <div class="section-box" style="margin-bottom: 2rem;">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ’¼ COTISATIONS FACULTATIVES</h3>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Code</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSEA</td>
 <td style="padding: 0.75rem;">
 <div>Cotisations facultatives</div>
 <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Madelin, PER, retraite complÃ©mentaire</div>
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #d1d5db;">
 ${cotisationsFacultatives.toFixed(2)} â‚¬
 </td>
 </tr>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSAR</td>
 <td style="padding: 0.75rem;">Dont cotisations facultatives liÃ©es Ã  l'activitÃ© conventionnÃ©e</td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #d1d5db;">
 ${cotisationsFacultatives.toFixed(2)} â‚¬
 </td>
 </tr>
 </tbody>
 </table>
 </div>
 
 <!-- Section 4 - RÃ©partition des revenus nets -->
 <div class="section-box" style="margin-bottom: 2rem;">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">âœ… RÃ‰PARTITION DES REVENUS NETS</h3>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Code</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Type</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 <tr style="background: #f0fdf4; border: 2px solid #16a34a;">
 <td style="padding: 1rem; font-family: monospace; font-weight: 700; color: #065f46;">DSGA</td>
 <td style="padding: 1rem; font-weight: 700; color: #065f46;">
 <div>Revenus nets de l'activitÃ© conventionnÃ©e</div>
 <div style="font-size: 0.875rem; font-weight: 400; margin-top: 0.25rem;">
 Recettes - Frais pro - Cotisations obligatoires - Cotisations facultatives
 </div>
 </td>
 <td style="padding: 1rem; text-align: center; font-weight: 600; color: #16a34a;">BÃ©nÃ©fice</td>
 <td style="padding: 1rem; text-align: right; font-weight: 700; color: #16a34a; font-size: 1.25rem;">
 ${beneficeNet.toFixed(2)} â‚¬
 </td>
 </tr>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">DSHA</td>
 <td style="padding: 0.75rem;">Revenus nets de l'activitÃ© conventionnÃ©e</td>
 <td style="padding: 0.75rem; text-align: center; font-weight: 600; color: #9ca3af;">DÃ©ficit</td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #d1d5db;">
 -
 </td>
 </tr>
 </tbody>
 </table>
 </div>
 
 <!-- Section 5 - DÃ©claration 2042 C PRO -->
 <div class="section-box" style="margin-bottom: 2rem;">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“‹ DÃ‰CLARATION 2042 C PRO (Â§5 - BNC)</h3>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Code</th>
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">LibellÃ©</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 <tr style="background: #fef2f2; border: 2px solid #dc2626;">
 <td style="padding: 1rem; font-family: monospace; font-weight: 700; color: #991b1b;">5QC</td>
 <td style="padding: 1rem; font-weight: 700; color: #991b1b;">
 <div>Revenu fiscal : BÃ©nÃ©fice ou DÃ©ficit</div>
 <div style="font-size: 0.875rem; font-weight: 400; margin-top: 0.25rem;">
 Ã€ reporter sur votre dÃ©claration de revenus 2042 C PRO
 </div>
 </td>
 <td style="padding: 1rem; text-align: right; font-weight: 700; color: #dc2626; font-size: 1.25rem;">
 ${revenuFiscal.toFixed(2)} â‚¬
 </td>
 </tr>
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem; font-family: monospace; font-weight: 600; color: #6b7280;">5QB</td>
 <td style="padding: 0.75rem;">
 <div>Revenus exonÃ©rÃ©s</div>
 <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">ExonÃ©rations spÃ©cifiques (ZRR, JEI, etc.)</div>
 </td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #d1d5db;">
 -
 </td>
 </tr>
 </tbody>
 </table>
 </div>
 
 <!-- Section 6 - DÃ©tail des charges (pour information) -->
 <div class="section-box">
 <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š DÃ‰TAIL DES CHARGES PROFESSIONNELLES (Information)</h3>
 <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">
 Ces charges sont dÃ©jÃ  intÃ©grÃ©es dans le calcul du bÃ©nÃ©fice net DSGA ci-dessus.
 </p>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
 <th style="padding: 0.75rem; text-align: left; font-weight: 600;">CatÃ©gorie</th>
 <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Montant</th>
 </tr>
 </thead>
 <tbody>
 ${categoriesDepenses.filter(cat => cat.value !== 'cotisations').map(cat => {
 const montant = ventilationDepenses[cat.value];
 return `
 <tr style="border-bottom: 1px solid #e5e7eb;">
 <td style="padding: 0.75rem;">${cat.label}</td>
 <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${montant > 0 ? '#dc2626' : '#d1d5db'};">
 ${montant > 0 ? montant.toFixed(2) + ' â‚¬' : '-'}
 </td>
 </tr>
 `;
 }).join('')}
 <tr style="background: #fef2f2; font-weight: 700;">
 <td style="padding: 0.75rem;">TOTAL FRAIS PROFESSIONNELS</td>
 <td style="padding: 0.75rem; text-align: right; color: #dc2626; font-size: 1.125rem;">
 ${totalFraisPro.toFixed(2)} â‚¬
 </td>
 </tr>
 </tbody>
 </table>
 </div>
 
 <!-- Section informative -->
 <div style="background: #eff6ff; border-left: 4px solid #2563eb; padding: 1rem; margin-top: 2rem; border-radius: 0.5rem;">
 <h4 style="margin: 0 0 0.5rem 0; color: #1e40af; font-size: 0.875rem; font-weight: 600;">â„¹ï¸ Informations importantes</h4>
 <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.875rem; color: #1e3a8a; line-height: 1.6;">
 <li><strong>Revenu fiscal (5QC)</strong> : ${revenuFiscal.toFixed(2)} â‚¬ Ã  reporter sur votre dÃ©claration 2042 C PRO</li>
 <li><strong>Revenu social</strong> : ${revenuSocial.toFixed(2)} â‚¬ (base de calcul des cotisations sociales)</li>
 <li>Taux de charges professionnelles : <strong>${tauxCharges.toFixed(1)}%</strong> des recettes</li>
 <li>Taux de cotisations sociales : <strong>${tauxCotisations.toFixed(1)}%</strong> des recettes</li>
 <li>Les donnÃ©es DSAV/DSAW sont transmises automatiquement par la CNAM Ã  l'administration fiscale</li>
 <li>Conservez tous vos justificatifs pendant au moins 6 ans</li>
 <li>L'adhÃ©sion Ã  une AGA vous Ã©vite la majoration de 25% du bÃ©nÃ©fice</li>
 </ul>
 </div>
 `;
 }
 // Rendu ParamÃ¨tres
 function renderParametres(container) {
 container.innerHTML = `
 <div class="content-header">
 <h2>âš™ï¸ ParamÃ¨tres</h2>
 </div>
 
 <div class="section-box" style="margin-bottom: 2rem;">
 <h4 style="margin-bottom: 1rem;">Identification de la structure</h4>
 <div style="display: grid; gap: 1rem;">
 <div>
 <label class="form-label">Nom de la structure</label>
 <input type="text" id="structure-nom" class="form-input" value="${appData.parametres.structure?.nom || ''}" onchange="updateStructure()">
 </div>
 <div>
 <label class="form-label">Adresse</label>
 <input type="text" id="structure-adresse" class="form-input" value="${appData.parametres.structure?.adresse || ''}" onchange="updateStructure()">
 </div>
 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
 <div>
 <label class="form-label">NumÃ©ro (RPPS / ADELI)</label>
 <input type="text" id="structure-numero" class="form-input" value="${appData.parametres.structure?.numero || ''}" onchange="updateStructure()">
 </div>
 <div>
 <label class="form-label">Email</label>
 <input type="email" id="structure-email" class="form-input" value="${appData.parametres.structure?.email || ''}" onchange="updateStructure()" placeholder="contact@cabinet.fr">
 </div>
 </div>
 </div>
 </div>
 
 <div class="section-box" style="margin-bottom: 2rem;">
 <h4 style="margin-bottom: 1rem;">Professionnel de santÃ©</h4>
 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
 <div>
 <label class="form-label">Nom</label>
 <input type="text" id="professionnel-nom" class="form-input" value="${appData.parametres.professionnel?.nom || ''}" onchange="updateProfessionnel()">
 </div>
 <div>
 <label class="form-label">PrÃ©nom</label>
 <input type="text" id="professionnel-prenom" class="form-input" value="${appData.parametres.professionnel?.prenom || ''}" onchange="updateProfessionnel()">
 </div>
 </div>
 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
 <div>
 <label class="form-label">NumÃ©ro RPPS / ADELI</label>
 <input type="text" id="professionnel-numero" class="form-input" value="${appData.parametres.professionnel?.numeroRPPS || ''}" onchange="updateProfessionnel()">
 </div>
 <div>
 <label class="form-label">Adresse du cabinet</label>
 <input type="text" id="professionnel-adresse" class="form-input" value="${appData.parametres.professionnel?.adresseCabinet || ''}" onchange="updateProfessionnel()">
 </div>
 </div>
 </div>

 <div class="section-box" style="margin-bottom: 2rem;">
 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
 <h4 style="margin: 0;">Types d'actes</h4>
 <button class="button button-primary" onclick="openTypeActeModal()">â• Nouveau type</button>
 </div>
 <table>
 <thead>
 <tr>
 <th>Code</th>
 <th>LibellÃ©</th>
 <th>CatÃ©gorie</th>
 <th>Montant</th>
 <th>DÃ©placement</th>
 <th>Actions</th>
 </tr>
 </thead>
 <tbody>
 ${appData.parametres.typesActes.map((type, index) => `
 <tr>
 <td><strong>${type.code}</strong></td>
 <td>${type.libelle}</td>
 <td><span class="badge ${type.categorie === 'HAD' ? 'badge-blue' : 'badge-purple'}">${type.categorie || 'HAD'}</span></td>
 <td>${type.montant.toFixed(2)} â‚¬</td>
 <td>${(type.montantDeplacement || 0).toFixed(2)} â‚¬</td>
 <td>
 <button class="action-button" onclick="editTypeActe(${index})" style="color: #2563eb;">âœï¸</button>
 <button class="action-button" onclick="deleteTypeActe(${index})" style="color: #dc2626;">ğŸ—‘ï¸</button>
 </td>
 </tr>
 `).join('')}
 </tbody>
 </table>
 </div>
 <div style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 0.5rem;">
 <p style="margin: 0; font-size: 0.875rem; color: #78350f;">
 â„¹ï¸ <strong>Note :</strong> Les modifications des types d'actes s'appliquent uniquement aux nouveaux actes crÃ©Ã©s. Les actes existants conservent leurs valeurs d'origine.
 </p>
 </div>
 
 <div style="margin-top: 2rem; padding: 1.5rem; background: #eff6ff; border: 2px solid #3b82f6; border-radius: 0.5rem;">
 <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
 <span style="font-size: 1.5rem;">ğŸ”„</span>
 <h3 style="color: #1e40af; font-weight: bold; margin: 0;">RÃ©initialiser types d'actes</h3>
 </div>
 <p style="color: #6b7280; margin-bottom: 1rem; line-height: 1.5;">
 Si vos types d'actes ne sont pas Ã  jour ou ne se synchronisent pas correctement avec Firebase, utilisez cet outil pour les rÃ©initialiser avec les valeurs par dÃ©faut.
 </p>
 <div style="background: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; color: #6b7280;">
 <strong style="color: #1e40af;">Cet outil va :</strong><br>
 â€¢ Supprimer tous les types d'actes actuels<br>
 â€¢ CrÃ©er les 5 types d'actes par dÃ©faut (HAD + READOM)<br>
 â€¢ Avec les montants de dÃ©placement corrects<br>
 â€¢ Synchroniser immÃ©diatement vers Firebase
 </div>
 <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem; color: #78350f;">
 âš ï¸ <strong>Attention :</strong> Cette action supprimera vos types d'actes personnalisÃ©s si vous en avez crÃ©Ã©s.
 </div>
 <button class="button" onclick="resetTypesActes()" style="background: #3b82f6; color: white; font-weight: 600;">
 ğŸ”„ RÃ©initialiser les types d'actes
 </button>
 </div>
 
 <div style="margin-top: 2rem; padding: 1.5rem; background: #fef9e7; border: 2px solid #f59e0b; border-radius: 0.5rem;">
 <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
 <span style="font-size: 1.5rem;">ğŸ§¹</span>
 <h3 style="color: #92400e; font-weight: bold; margin: 0;">Nettoyage des doublons</h3>
 </div>
 <p style="color: #6b7280; margin-bottom: 1rem; line-height: 1.5;">
 Si vous avez des patients qui apparaissent en double dans la liste, utilisez cet outil pour nettoyer automatiquement les doublons.
 </p>
 <div style="background: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; color: #6b7280;">
 <strong style="color: #92400e;">Comment Ã§a marche :</strong><br>
 â€¢ DÃ©tecte les patients avec nom et prÃ©nom identiques<br>
 â€¢ Conserve la version Firebase (synchronisÃ©e)<br>
 â€¢ Supprime les versions locales (doublons)<br>
 â€¢ Sans risque : les donnÃ©es Firebase sont prÃ©servÃ©es
 </div>
 <button class="button" onclick="cleanupDuplicatePatients()" style="background: #f59e0b; color: white; font-weight: 600;">
 ğŸ§¹ Nettoyer les doublons maintenant
 </button>
 </div>
 
 <div style="margin-top: 3rem; padding: 1.5rem; background: #fef2f2; border: 2px solid #dc2626; border-radius: 0.5rem;">
 <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
 <span style="font-size: 1.5rem;">âš ï¸</span>
 <h3 style="color: #dc2626; font-weight: bold; margin: 0;">Zone dangereuse</h3>
 </div>
 <p style="color: #6b7280; margin-bottom: 1.5rem; line-height: 1.5;">
 Cette action supprimera <strong style="color: #dc2626;">dÃ©finitivement</strong> toutes vos donnÃ©es (patients, actes, bilans, factures, rÃ¨glements et dÃ©penses).<br>
 Vos <strong>paramÃ¨tres seront conservÃ©s</strong>. Cette action est <strong style="color: #dc2626;">irrÃ©versible</strong>.
 </p>
 <button class="button button-danger" onclick="resetAllData()">
 ğŸ—‘ï¸ Remise Ã  zÃ©ro des donnÃ©es
 </button>
 </div>
 `;
 }
 // Gestion des types d'actes
 function openTypeActeModal(index = null) {
 const type = index !== null ? appData.parametres.typesActes[index] : null;
 editingItem = index;
 
 openModal(
 type ? 'Modifier type d\'acte' : 'Nouveau type d\'acte',
 `
 <div class="form-group">
 <label class="form-label">Code *</label>
 <input type="text" id="type-code" class="form-input" value="${type?.code || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">LibellÃ© *</label>
 <input type="text" id="type-libelle" class="form-input" value="${type?.libelle || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">CatÃ©gorie *</label>
 <select id="type-categorie" class="form-input">
 <option value="HAD" ${type?.categorie === 'HAD' || !type ? 'selected' : ''}>HAD</option>
 <option value="READOM" ${type?.categorie === 'READOM' ? 'selected' : ''}>READOM</option>
 </select>
 </div>
 <div class="form-group">
 <label class="form-label">Montant (â‚¬) *</label>
 <input type="number" step="0.01" id="type-montant" class="form-input" value="${type?.montant || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">IndemnitÃ© de dÃ©placement (â‚¬)</label>
 <input type="number" step="0.01" id="type-deplacement" class="form-input" value="${type?.montantDeplacement || 0}" placeholder="0.00">
 <small style="color: #6b7280; font-size: 0.75rem;">Montant de l'indemnitÃ© forfaitaire de dÃ©placement pour ce type d'acte</small>
 </div>
 <button class="button button-primary" style="width: 100%;" onclick="saveTypeActe()">${type ? 'Modifier' : 'Ajouter'}</button>
 `
 );
 }
 function saveTypeActe() {
 const code = document.getElementById('type-code').value.trim();
 const libelle = document.getElementById('type-libelle').value.trim();
 const categorie = document.getElementById('type-categorie').value;
 const montant = parseFloat(document.getElementById('type-montant').value);
 const montantDeplacement = parseFloat(document.getElementById('type-deplacement').value) || 0;
 
 if (!code || !libelle || !montant) {
 alert('Code, libellÃ© et montant sont requis');
 return;
 }
 
 const typeActe = { 
 code, 
 libelle, 
 categorie,
 montant,
 montantDeplacement
 };
 
 if (editingItem !== null) {
 appData.parametres.typesActes[editingItem] = typeActe;
 } else {
 appData.parametres.typesActes.push(typeActe);
 }
 
 saveData();
 
 // Synchroniser vers Firebase
 if (firebaseReady) {
 syncTypesActesToFirebase();
 }
 
 closeModal();
 }
 function editTypeActe(index) {
 openTypeActeModal(index);
 }
 function deleteTypeActe(index) {
 if (!confirm('Supprimer ce type d\'acte ?')) return;
 appData.parametres.typesActes.splice(index, 1);
 saveData();
 }
 function updateIndemniteDeplacement() {
 appData.parametres.indemniteDeplacement.actif = document.getElementById('indemnite-actif').checked;
 appData.parametres.indemniteDeplacement.montant = parseFloat(document.getElementById('indemnite-montant').value) || 0;
 saveData();
 }
 function updateDepassement() {
 if (!appData.parametres.depassement) {
 appData.parametres.depassement = {};
 }
 appData.parametres.depassement.actif = document.getElementById('depassement-actif').checked;
 appData.parametres.depassement.montant = parseFloat(document.getElementById('depassement-montant').value) || 0;
 saveData();
 }
 function updateStructure() {
 if (!appData.parametres.structure) {
 appData.parametres.structure = {};
 }
 appData.parametres.structure.nom = document.getElementById('structure-nom').value.trim();
 appData.parametres.structure.adresse = document.getElementById('structure-adresse').value.trim();
 appData.parametres.structure.numero = document.getElementById('structure-numero').value.trim();
 appData.parametres.structure.email = document.getElementById('structure-email').value.trim();
 saveData();
 }
 function updateProfessionnel() {
 if (!appData.parametres.professionnel) {
 appData.parametres.professionnel = {};
 }
 appData.parametres.professionnel.nom = document.getElementById('professionnel-nom').value.trim();
 appData.parametres.professionnel.prenom = document.getElementById('professionnel-prenom').value.trim();
 appData.parametres.professionnel.numeroRPPS = document.getElementById('professionnel-numero').value.trim();
 appData.parametres.professionnel.adresseCabinet = document.getElementById('professionnel-adresse').value.trim();
 saveData();
 }
 function resetAllData() {
 const confirmation1 = confirm('âš ï¸ ATTENTION - SUPPRESSION DES DONNÃ‰ES âš ï¸\n\nÃŠtes-vous VRAIMENT sÃ»r de vouloir supprimer TOUTES vos donnÃ©es ?\n\nCe qui sera supprimÃ© :\nâ€¢ Tous les patients\nâ€¢ Tous les actes\nâ€¢ Tous les bilans\nâ€¢ Toutes les factures\nâ€¢ Tous les rÃ¨glements\nâ€¢ Toutes les dÃ©penses\n\nCe qui sera conservÃ© :\nâœ“ Vos paramÃ¨tres (types d\'actes, indemnitÃ©s, infos structure)\n\nCette action est IRRÃ‰VERSIBLE !\n\nAppuyez sur OK pour continuer ou Annuler pour abandonner.');
 
 if (!confirmation1) return;
 
 const confirmation2 = confirm('âš ï¸ DERNIÃˆRE CONFIRMATION âš ï¸\n\nVous Ãªtes sur le point de supprimer dÃ©finitivement toutes vos donnÃ©es.\n\nIl n\'y aura AUCUN moyen de les rÃ©cupÃ©rer.\n\nCliquez sur OK pour CONFIRMER LA SUPPRESSION\nou sur Annuler pour arrÃªter.');
 
 if (!confirmation2) return;
 
 // Sauvegarder uniquement les paramÃ¨tres
 const parametresSauvegardes = { ...appData.parametres };
 
 // RÃ©initialiser toutes les donnÃ©es sauf les paramÃ¨tres
 appData = {
 patients: [],
 actes: [],
 bilans: [],
 factures: [],
 reglements: [],
 depenses: [],
 parametres: parametresSauvegardes
 };
 
 saveData();
 
 // NOUVEAU : Supprimer aussi dans Firebase
 if (firebaseReady) {
 console.log('ğŸ—‘ï¸ Suppression des donnÃ©es Firebase...');
 
 // Supprimer tous les patients
 database.ref('patients').remove().then(() => {
 console.log('âœ… Patients supprimÃ©s de Firebase');
 }).catch(err => {
 console.error('âŒ Erreur suppression patients Firebase:', err);
 });
 
 // Supprimer tous les actes
 database.ref('actes').remove().then(() => {
 console.log('âœ… Actes supprimÃ©s de Firebase');
 }).catch(err => {
 console.error('âŒ Erreur suppression actes Firebase:', err);
 });
 
 // Supprimer tous les bilans
 database.ref('bilans').remove().then(() => {
 console.log('âœ… Bilans supprimÃ©s de Firebase');
 }).catch(err => {
 console.error('âŒ Erreur suppression bilans Firebase:', err);
 });
 
 // Note : On garde typesActes car c'est dans parametres
 }
 
 alert('âœ… Remise Ã  zÃ©ro effectuÃ©e\n\nToutes vos donnÃ©es ont Ã©tÃ© supprimÃ©es (local + cloud).\nVos paramÃ¨tres ont Ã©tÃ© conservÃ©s.');
 
 // Recharger la page pour rafraÃ®chir l'affichage
 setTimeout(() => {
 location.reload();
 }, 1000); // Attendre 1 seconde pour que Firebase se mette Ã  jour
 }
 // Fonctions utilitaires
 function getPatientName(patientId) {
 const patient = appData.patients.find(p => p.id === patientId);
 return patient ? `${patient.nom} ${patient.prenom}` : 'Inconnu';
 }
 function getActeMontantTotal(acte) {
 const montantBase = acte.montant || 0;
 const montantIndemnite = acte.indemnite ? (acte.montantIndemnite || 0) : 0;
 return montantBase + montantIndemnite;
 }
 function getToday() {
 return new Date().toISOString().split('T')[0];
 }
 function generateId() {
 return Date.now();
 }
 function generateNumeroFacture() {
 if (appData.factures.length === 0) {
 const year = new Date().getFullYear();
 return `F${year}-001`;
 }
 
 // RÃ©cupÃ©rer le dernier numÃ©ro
 const lastFacture = appData.factures[appData.factures.length - 1];
 const lastNumero = lastFacture.numero;
 
 // Extraire l'annÃ©e et le numÃ©ro
 const match = lastNumero.match(/F(\d{4})-(\d+)/);
 if (match) {
 const year = parseInt(match[1]);
 const num = parseInt(match[2]);
 const currentYear = new Date().getFullYear();
 
 // Si changement d'annÃ©e, rÃ©initialiser Ã  001
 if (year !== currentYear) {
 return `F${currentYear}-001`;
 }
 
 // Sinon incrÃ©menter
 const nextNum = (num + 1).toString().padStart(3, '0');
 return `F${currentYear}-${nextNum}`;
 }
 
 // Format invalide, crÃ©er un nouveau numÃ©ro
 const year = new Date().getFullYear();
 return `F${year}-001`;
 }
 // Modal
 function openModal(title, content) {
 document.getElementById('modal-title').textContent = title;
 document.getElementById('modal-body').innerHTML = content;
 document.getElementById('modal').classList.add('active');
 }
 function closeModal() {
 document.getElementById('modal').classList.remove('active');
 editingItem = null;
 selectedActes = [];
 currentPatientFilter = null;
 }
 // CRUD Patients
 function openPatientModal(id = null) {
 editingItem = id ? appData.patients.find(p => p.id === id) : null;
 
 openModal(
 id ? 'Modifier patient' : 'Nouveau patient',
 `
 <div class="form-group">
 <label class="form-label">Nom *</label>
 <input type="text" id="patient-nom" class="form-input" value="${editingItem?.nom || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">PrÃ©nom *</label>
 <input type="text" id="patient-prenom" class="form-input" value="${editingItem?.prenom || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">TÃ©lÃ©phone</label>
 <input type="tel" id="patient-telephone" class="form-input" value="${editingItem?.telephone || ''}">
 </div>
 <div class="form-group">
 <label class="form-label">Adresse</label>
 <textarea id="patient-adresse" class="form-textarea" rows="3">${editingItem?.adresse || ''}</textarea>
 </div>
 <div class="form-group">
 <label class="form-label">NÂ° SÃ©cu</label>
 <input type="text" id="patient-numSecu" class="form-input" value="${editingItem?.numSecu || ''}">
 </div>
 <button class="button button-primary" style="width: 100%;" onclick="savePatient()">${id ? 'Modifier' : 'Enregistrer'}</button>
 `
 );
 }
 function savePatient() {
 try {
 console.log('ğŸ”µ DÃ©but savePatient');
 
 const nom = document.getElementById('patient-nom').value.trim();
 const prenom = document.getElementById('patient-prenom').value.trim();
 
 console.log('ğŸ”µ Nom:', nom, 'PrÃ©nom:', prenom);
 
 if (!nom || !prenom) {
 alert('Nom et prÃ©nom requis');
 return;
 }
 
 // Chercher si un patient avec ce nom/prÃ©nom existe dÃ©jÃ 
 const existingPatient = appData.patients.find(p => 
 p.nom.toLowerCase() === nom.toLowerCase() && 
 p.prenom.toLowerCase() === prenom.toLowerCase()
 );
 
 if (editingItem) {
 // MODE Ã‰DITION
 console.log('ğŸ”µ Mode Ã©dition');
 
 const patient = {
 id: editingItem.id,
 nom,
 prenom,
 telephone: document.getElementById('patient-telephone').value.trim(),
 adresse: document.getElementById('patient-adresse').value.trim(),
 numeroSecuriteSociale: document.getElementById('patient-numSecu').value.trim(),
 numSecu: document.getElementById('patient-numSecu').value.trim(),
 actif: editingItem.actif !== undefined ? editingItem.actif : true
 };
 
 const index = appData.patients.findIndex(p => p.id === editingItem.id);
 if (index !== -1) {
 appData.patients[index] = patient;
 console.log('âœ… Patient modifiÃ©');
 
 // Synchroniser vers Firebase
 if (firebaseReady) {
 syncPatientToFirebase(patient);
 }
 }
 } else {
 // MODE CRÃ‰ATION
 console.log('ğŸ”µ Mode crÃ©ation');
 
 // VÃ©rifier doublon nom/prÃ©nom
 if (existingPatient && existingPatient.id !== editingItem?.id) {
 alert(`âš ï¸ Un patient "${nom} ${prenom}" existe dÃ©jÃ  !\n\nVeuillez modifier le patient existant au lieu d'en crÃ©er un nouveau.`);
 return;
 }
 
 // CrÃ©er le patient avec ID temporaire
 const tempPatient = {
 id: 'temp_' + Date.now(),
 nom,
 prenom,
 telephone: document.getElementById('patient-telephone').value.trim(),
 adresse: document.getElementById('patient-adresse').value.trim(),
 numeroSecuriteSociale: document.getElementById('patient-numSecu').value.trim(),
 numSecu: document.getElementById('patient-numSecu').value.trim(),
 actif: true
 };
 
 console.log('âœ… Patient crÃ©Ã© avec ID temporaire:', tempPatient.id);
 
 // Synchroniser IMMÃ‰DIATEMENT vers Firebase pour obtenir l'ID Firebase
 if (firebaseReady) {
 syncPatientToFirebase(tempPatient, (firebaseId) => {
 // Callback : remplacer l'ID temporaire par l'ID Firebase
 tempPatient.id = firebaseId;
 appData.patients.push(tempPatient);
 saveData();
 console.log('âœ… Patient ajoutÃ© avec ID Firebase:', firebaseId);
 });
 } else {
 // Pas de Firebase, utiliser ID local
 tempPatient.id = generateId();
 appData.patients.push(tempPatient);
 console.log('âœ… Patient ajoutÃ© localement');
 }
 }
 
 saveData();
 console.log('âœ… DonnÃ©es sauvegardÃ©es');
 
 closeModal();
 console.log('âœ… Modal fermÃ©e');
 
 } catch (error) {
 console.error('âŒ ERREUR dans savePatient:', error);
 alert('Erreur lors de la sauvegarde : ' + error.message);
 }
 }
 function editPatient(id) {
 openPatientModal(id);
 }
 function navigateToPatient(address, app) {
 if (!address || address.trim() === '') {
 alert('Aucune adresse renseignÃ©e pour ce patient');
 return;
 }
 
 const encodedAddress = encodeURIComponent(address);
 
 if (app === 'maps') {
 // Google Maps
 window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`, '_blank');
 } else if (app === 'waze') {
 // Waze
 window.open(`https://waze.com/ul?q=${encodedAddress}&navigate=yes`, '_blank');
 }
 }
 
 function deletePatient(id) {
 if (!confirm('Supprimer ce patient ?')) return;
 appData.patients = appData.patients.filter(p => p.id !== id);
 saveData();
 }
 function togglePatientActif(id) {
 const patient = appData.patients.find(p => p.id === id);
 if (patient) {
 patient.actif = patient.actif === false ? true : false;
 saveData();
 }
 }
 // CRUD Actes
 function openActeModal(id = null) {
 editingItem = id ? appData.actes.find(a => a.id === id) : null;
 
 // Ne montrer que les patients actifs
 const patientsActifs = appData.patients.filter(p => p.actif !== false);
 
 openModal(
 id ? 'Modifier acte' : 'Nouveau acte',
 `
 <div class="form-group">
 <label class="form-label">Date *</label>
 <input type="date" id="acte-date" class="form-input" value="${editingItem?.date || getToday()}" required>
 </div>
 <div class="form-group">
 <label class="form-label">Patient *</label>
 <select id="acte-patient" class="form-select" required>
 <option value="">SÃ©lectionner patient</option>
 ${patientsActifs.map(p => `<option value="${p.id}" ${editingItem?.patientId === p.id ? 'selected' : ''}>${p.nom} ${p.prenom}</option>`).join('')}
 </select>
 </div>
 <div class="form-group">
 <label class="form-label">Type d'acte</label>
 <select id="acte-type" class="form-select" onchange="updateActeMontant()">
 ${appData.parametres.typesActes.map(type => `<option value="${type.code}" data-montant="${type.montant}" ${editingItem?.typeActe === type.code ? 'selected' : ''}>${type.code} - ${type.libelle}</option>`).join('')}
 </select>
 </div>
 <div class="form-group">
 <label class="checkbox-label">
 <input type="checkbox" id="acte-bilan" class="form-checkbox" ${editingItem?.bilan ? 'checked' : ''}>
 <span>Bilan</span>
 </label>
 </div>
 <div class="form-group">
 <label class="form-label">Notes / Observations</label>
 <textarea id="acte-notes" class="form-textarea" rows="3">${editingItem?.notes || ''}</textarea>
 </div>
 <div class="form-group">
 <label class="form-label">Montant de base *</label>
 <input type="number" step="0.01" id="acte-montant" class="form-input" value="${editingItem?.montant || (appData.parametres.typesActes[0]?.montant || '')}" required onchange="updateActeTotal()">
 </div>
 <div class="form-group">
 <label class="checkbox-label">
 <input type="checkbox" id="acte-indemnite" class="form-checkbox" ${editingItem?.indemnite ? 'checked' : ''} onchange="updateActeTotal()">
 <span>IndemnitÃ© forfaitaire de dÃ©placement (IFD)</span>
 </label>
 </div>
 <div class="form-group" id="acte-indemnite-group" style="margin-left: 2rem; ${editingItem?.indemnite ? '' : 'display: none;'}">
 <label class="form-label">Montant IFD (â‚¬)</label>
 <input type="number" step="0.01" id="acte-indemnite-montant" class="form-input" value="${editingItem?.montantIndemnite || 0}" onchange="updateActeTotal()">
 </div>
 <div class="form-group" style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem;">
 <label class="form-label" style="color: #1e40af;">Montant total de l'acte</label>
 <div id="acte-total" style="font-size: 1.5rem; font-weight: bold; color: #2563eb;">0.00 â‚¬</div>
 </div>
 <button class="button button-primary" style="width: 100%;" onclick="saveActe()">${id ? 'Modifier' : 'Enregistrer'}</button>
 `
 );
 
 if (!editingItem) {
 updateActeMontant();
 }
 updateActeTotal();
 }
 function updateActeTotal() {
 const montantBase = parseFloat(document.getElementById('acte-montant')?.value) || 0;
 
 // IFD
 const avecIndemnite = document.getElementById('acte-indemnite')?.checked;
 const montantIndemnite = avecIndemnite ? (parseFloat(document.getElementById('acte-indemnite-montant')?.value) || 0) : 0;
 
 const total = montantBase + montantIndemnite;
 
 const totalDiv = document.getElementById('acte-total');
 if (totalDiv) {
 totalDiv.textContent = total.toFixed(2) + ' â‚¬';
 }
 
 // Afficher/masquer champ montant IFD
 const ifdGroup = document.getElementById('acte-indemnite-group');
 if (ifdGroup) {
 ifdGroup.style.display = avecIndemnite ? 'block' : 'none';
 }
 }
 function updateActeMontant() {
 const select = document.getElementById('acte-type');
 const typeCode = select.value;
 
 // Trouver le type d'acte complet
 const typeActe = appData.parametres.typesActes.find(t => t.code === typeCode);
 
 if (typeActe) {
 // Remplir montant de base
 document.getElementById('acte-montant').value = typeActe.montant;
 
 // GÃ©rer IFD
 const montantDeplacement = typeActe.montantDeplacement || 0;
 const checkboxIfd = document.getElementById('acte-indemnite');
 const inputIfd = document.getElementById('acte-indemnite-montant');
 
 if (montantDeplacement > 0) {
 // Type d'acte avec dÃ©placement : cocher et remplir
 checkboxIfd.checked = true;
 checkboxIfd.disabled = false;
 inputIfd.value = montantDeplacement.toFixed(2);
 } else {
 // Type d'acte sans dÃ©placement : dÃ©cocher et dÃ©sactiver
 checkboxIfd.checked = false;
 checkboxIfd.disabled = true;
 inputIfd.value = '0.00';
 }
 }
 
 updateActeTotal();
 }
 function saveActe() {
 const date = document.getElementById('acte-date').value;
 const patientId = parseInt(document.getElementById('acte-patient').value);
 const montant = parseFloat(document.getElementById('acte-montant').value);
 const indemnite = document.getElementById('acte-indemnite').checked;
 const montantIndemnite = indemnite ? (parseFloat(document.getElementById('acte-indemnite-montant').value) || 0) : 0;
 
 if (!date || !patientId || !montant) {
 alert('Date, patient et montant requis');
 return;
 }
 
 const acte = {
 id: editingItem?.id || generateId(),
 date,
 patientId,
 typeActe: document.getElementById('acte-type').value,
 bilan: document.getElementById('acte-bilan').checked,
 indemnite: indemnite,
 montantIndemnite: montantIndemnite,
 notes: document.getElementById('acte-notes').value.trim(),
 montant,
 statut: editingItem?.statut || 'en_attente',
 factureId: editingItem?.factureId || null,
 reglementId: editingItem?.reglementId || null
 };
 
 if (editingItem) {
 const index = appData.actes.findIndex(a => a.id === editingItem.id);
 appData.actes[index] = acte;
 } else {
 appData.actes.push(acte);
 }
 
 saveData();
 closeModal();
 }
 function editActe(id) {
 openActeModal(id);
 }
 function deleteActe(id) {
 if (!confirm('Supprimer cet acte ?')) return;
 appData.actes = appData.actes.filter(a => a.id !== id);
 saveData();
 }
 // Saisie en masse d'actes
 function openActesMasseModal() {
 // Ne montrer que les patients actifs
 const patientsActifs = appData.patients.filter(p => p.actif !== false);
 
 openModal(
 'Saisie d\'actes en masse',
 `
 <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
 <p style="margin: 0; font-size: 0.875rem; color: #1e3a8a;">
 ğŸ’¡ <strong>Astuce :</strong> Saisissez plusieurs actes pour un mÃªme patient en une seule fois. Le type d'acte sera prÃ©-rempli avec le dernier acte de ce patient. Laissez vides les dates non utilisÃ©es.
 </p>
 </div>
 
 <div class="form-group">
 <label class="form-label">Patient *</label>
 <select id="acteMasse-patient" class="form-select" onchange="updateActeMasseDefaults()" required>
 <option value="">SÃ©lectionner patient</option>
 ${patientsActifs.map(p => `<option value="${p.id}">${p.nom} ${p.prenom}</option>`).join('')}
 </select>
 </div>
 
 <div id="acteMasse-info" style="display: none; background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
 <p style="margin: 0; font-size: 0.875rem; color: #0369a1;">
 <strong>Type par dÃ©faut :</strong> <span id="acteMasse-typeDefaut">-</span>
 </p>
 </div>
 
 <div class="form-group">
 <label class="form-label">Type d'acte par dÃ©faut</label>
 <select id="acteMasse-type" class="form-select">
 ${appData.parametres.typesActes.map(type => `<option value="${type.code}" data-montant="${type.montant}">${type.code} - ${type.libelle}</option>`).join('')}
 </select>
 </div>
 
 <div class="form-group">
 <label class="checkbox-label">
 <input type="checkbox" id="acteMasse-bilan" class="form-checkbox">
 <span>Avec bilan</span>
 </label>
 </div>
 
 <div style="border-top: 2px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
 <h4 style="margin-bottom: 1rem;">Dates des actes (laissez vides les dates non utilisÃ©es)</h4>
 
 <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
 <div class="form-group">
 <label class="form-label">Date 1</label>
 <input type="date" class="form-input acteMasse-date" value="${getToday()}">
 </div>
 <div class="form-group">
 <label class="form-label">Date 2</label>
 <input type="date" class="form-input acteMasse-date">
 </div>
 <div class="form-group">
 <label class="form-label">Date 3</label>
 <input type="date" class="form-input acteMasse-date">
 </div>
 <div class="form-group">
 <label class="form-label">Date 4</label>
 <input type="date" class="form-input acteMasse-date">
 </div>
 <div class="form-group">
 <label class="form-label">Date 5</label>
 <input type="date" class="form-input acteMasse-date">
 </div>
 <div class="form-group">
 <label class="form-label">Date 6</label>
 <input type="date" class="form-input acteMasse-date">
 </div>
 </div>
 </div>
 
 <button class="button button-primary" style="width: 100%; margin-top: 1rem;" onclick="saveActesMasse()">ğŸ’¾ Enregistrer tous les actes</button>
 `
 );
 }
 
 function updateActeMasseDefaults() {
 const patientId = parseInt(document.getElementById('acteMasse-patient').value);
 if (!patientId) {
 document.getElementById('acteMasse-info').style.display = 'none';
 return;
 }
 
 // Trouver le dernier acte de ce patient
 const actesPatient = appData.actes.filter(a => a.patientId === patientId);
 if (actesPatient.length > 0) {
 // Trier par date dÃ©croissante
 const dernierActe = actesPatient.sort((a, b) => b.date.localeCompare(a.date))[0];
 
 // PrÃ©-remplir le type d'acte
 const selectType = document.getElementById('acteMasse-type');
 selectType.value = dernierActe.typeActe;
 
 // Afficher l'info
 const typeActeInfo = appData.parametres.typesActes.find(t => t.code === dernierActe.typeActe);
 document.getElementById('acteMasse-typeDefaut').textContent = 
 typeActeInfo ? `${typeActeInfo.code} - ${typeActeInfo.libelle}` : dernierActe.typeActe;
 document.getElementById('acteMasse-info').style.display = 'block';
 
 // PrÃ©-cocher bilan si le dernier avait un bilan
 document.getElementById('acteMasse-bilan').checked = dernierActe.bilan || false;
 } else {
 document.getElementById('acteMasse-info').style.display = 'none';
 }
 }
 
 function saveActesMasse() {
 const patientId = parseInt(document.getElementById('acteMasse-patient').value);
 const typeActe = document.getElementById('acteMasse-type').value;
 const bilan = document.getElementById('acteMasse-bilan').checked;
 
 if (!patientId) {
 alert('Veuillez sÃ©lectionner un patient');
 return;
 }
 
 // RÃ©cupÃ©rer toutes les dates (uniquement celles qui sont remplies)
 const dateInputs = document.querySelectorAll('.acteMasse-date');
 const dates = Array.from(dateInputs).map(input => input.value).filter(d => d);
 
 if (dates.length === 0) {
 alert('Veuillez saisir au moins une date');
 return;
 }
 
 // RÃ©cupÃ©rer le montant du type d'acte sÃ©lectionnÃ©
 const typeActeInfo = appData.parametres.typesActes.find(t => t.code === typeActe);
 const montant = typeActeInfo ? typeActeInfo.montant : 0;
 
 // CrÃ©er un acte pour chaque date
 let baseId = Date.now();
 dates.forEach((date, index) => {
 const acte = {
 id: baseId + index, // ID unique en ajoutant l'index
 date: date,
 patientId: patientId,
 typeActe: typeActe,
 montant: montant,
 bilan: bilan,
 statut: 'en_attente',
 notes: ''
 };
 appData.actes.push(acte);
 });
 
 saveData();
 closeModal();
 
 alert(`âœ… ${dates.length} acte(s) enregistrÃ©(s) avec succÃ¨s !`);
 }
 // CRUD Bilans
 function createBilanForPatient(patientId) {
 openBilanModal(null, patientId);
 }
 function openBilanFromActe(acteId) {
 const acte = appData.actes.find(a => a.id === acteId);
 const bilanExistant = appData.bilans.find(b => b.acteId === acteId);
 
 if (bilanExistant) {
 openBilanModal(bilanExistant.id);
 } else {
 openBilanModal(null, acte.patientId, acteId);
 }
 }
 function openBilanModal(id = null, presetPatientId = null, presetActeId = null) {
 editingItem = id ? appData.bilans.find(b => b.id === id) : null;
 const patientId = editingItem?.patientId || presetPatientId;
 
 openModal(
 id ? 'Modifier bilan' : 'Nouveau bilan',
 `
 <button class="button button-success" style="width: 100%; margin-bottom: 1rem;" onclick="printBilanPreview()">ğŸ–¨ï¸ Imprimer le bilan</button>
 
 <div class="section-box">
 <h4>Informations gÃ©nÃ©rales</h4>
 <div class="form-group">
 <label class="form-label">Date *</label>
 <input type="date" id="bilan-date" class="form-input" value="${editingItem?.date || getToday()}" required>
 </div>
 <div class="form-group">
 <label class="form-label">Patient *</label>
 <select id="bilan-patient" class="form-select" ${id ? 'disabled' : ''} required>
 <option value="">SÃ©lectionner patient</option>
 ${appData.patients.map(p => `<option value="${p.id}" ${patientId === p.id ? 'selected' : ''}>${p.nom} ${p.prenom}</option>`).join('')}
 </select>
 </div>
 <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
 <label class="checkbox-label">
 <input type="checkbox" id="bilan-typeInitial" class="form-checkbox" ${editingItem?.typeInitial || presetActeId ? 'checked' : ''}>
 <span>Initiale</span>
 </label>
 <label class="checkbox-label">
 <input type="checkbox" id="bilan-typeIntermediaire" class="form-checkbox" ${editingItem?.typeIntermediaire ? 'checked' : ''}>
 <span>IntermÃ©diaire</span>
 </label>
 <label class="checkbox-label">
 <input type="checkbox" id="bilan-typeFinale" class="form-checkbox" ${editingItem?.typeFinale ? 'checked' : ''}>
 <span>Finale</span>
 </label>
 </div>
 </div>
 <div class="section-box">
 <h4>Diagnostic kinÃ©sithÃ©rapique</h4>
 <textarea id="bilan-diagnostic" class="form-textarea" rows="3" placeholder="Diagnostic...">${editingItem?.diagnostic || ''}</textarea>
 </div>
 <div class="section-box">
 <h4>Objectifs</h4>
 <div class="form-group">
 <label class="form-label">Ã€ court terme</label>
 <textarea id="bilan-objectifsCourtTerme" class="form-textarea" rows="2">${editingItem?.objectifsCourtTerme || ''}</textarea>
 </div>
 <div class="form-group">
 <label class="form-label">Ã€ moyen/long terme</label>
 <textarea id="bilan-objectifsLongTerme" class="form-textarea" rows="2">${editingItem?.objectifsLongTerme || ''}</textarea>
 </div>
 </div>
 <div class="section-box">
 <h4>Protocole thÃ©rapeutique</h4>
 <div class="form-group">
 <label class="form-label">Nombre de sÃ©ances</label>
 <input type="text" id="bilan-nombreSeances" class="form-input" value="${editingItem?.nombreSeances || ''}">
 </div>
 <div class="form-group">
 <label class="form-label">Techniques</label>
 <textarea id="bilan-techniques" class="form-textarea" rows="2">${editingItem?.techniques || ''}</textarea>
 </div>
 </div>
 <div class="section-box">
 <h4>Commentaires</h4>
 <textarea id="bilan-commentaires" class="form-textarea" rows="3">${editingItem?.commentaires || ''}</textarea>
 </div>
 <button class="button button-primary" style="width: 100%;" onclick="saveBilan(${presetActeId || 'null'})">${id ? 'Modifier' : 'Enregistrer'}</button>
 `
 );
 }
 function saveBilan(acteId = null) {
 const patientId = parseInt(document.getElementById('bilan-patient').value);
 const date = document.getElementById('bilan-date').value;
 
 if (!patientId || !date) {
 alert('Patient et date requis');
 return;
 }
 
 const bilan = {
 id: editingItem?.id || generateId(),
 patientId,
 date,
 acteId: acteId || editingItem?.acteId || null,
 typeInitial: document.getElementById('bilan-typeInitial').checked,
 typeIntermediaire: document.getElementById('bilan-typeIntermediaire').checked,
 typeFinale: document.getElementById('bilan-typeFinale').checked,
 diagnostic: document.getElementById('bilan-diagnostic').value.trim(),
 objectifsCourtTerme: document.getElementById('bilan-objectifsCourtTerme').value.trim(),
 objectifsLongTerme: document.getElementById('bilan-objectifsLongTerme').value.trim(),
 nombreSeances: document.getElementById('bilan-nombreSeances').value.trim(),
 techniques: document.getElementById('bilan-techniques').value.trim(),
 commentaires: document.getElementById('bilan-commentaires').value.trim()
 };
 
 if (editingItem) {
 const index = appData.bilans.findIndex(b => b.id === editingItem.id);
 appData.bilans[index] = bilan;
 } else {
 appData.bilans.push(bilan);
 }
 
 saveData();
 closeModal();
 }
 function editBilan(id) {
 openBilanModal(id);
 }
 function deleteBilan(id) {
 if (!confirm('Supprimer ce bilan ?')) return;
 appData.bilans = appData.bilans.filter(b => b.id !== id);
 saveData();
 }
 function printBilan(id) {
 const bilan = appData.bilans.find(b => b.id === id);
 if (!bilan) return;
 
 const patient = appData.patients.find(p => p.id === bilan.patientId);
 generateBilanHTML(bilan, patient);
 }
 function printBilanPreview() {
 const patientId = parseInt(document.getElementById('bilan-patient').value);
 const patient = appData.patients.find(p => p.id === patientId);
 
 if (!patient) {
 alert('Veuillez sÃ©lectionner un patient');
 return;
 }
 
 const bilanData = {
 date: document.getElementById('bilan-date').value,
 typeInitial: document.getElementById('bilan-typeInitial').checked,
 typeIntermediaire: document.getElementById('bilan-typeIntermediaire').checked,
 typeFinale: document.getElementById('bilan-typeFinale').checked,
 diagnostic: document.getElementById('bilan-diagnostic').value.trim(),
 objectifsCourtTerme: document.getElementById('bilan-objectifsCourtTerme').value.trim(),
 objectifsLongTerme: document.getElementById('bilan-objectifsLongTerme').value.trim(),
 nombreSeances: document.getElementById('bilan-nombreSeances').value.trim(),
 techniques: document.getElementById('bilan-techniques').value.trim(),
 commentaires: document.getElementById('bilan-commentaires').value.trim()
 };
 
 generateBilanHTML(bilanData, patient);
 }
 function generateBilanHTML(bilanData, patient) {
 const printWindow = window.open('', '_blank');
 printWindow.document.write(`
 <!DOCTYPE html>
 <html>
 <head>
 <meta charset="UTF-8">
 <title>Bilan - ${patient.nom} ${patient.prenom}</title>
 <style>
 @media print { @page { margin: 2cm; } }
 body { font-family: Arial; margin: 20px; line-height: 1.6; color: #333; }
 h1 { text-align: center; color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px; margin-bottom: 30px; }
 .info-patient { background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
 .section { margin: 20px 0; padding: 15px; border: 1px solid #d1d5db; border-radius: 8px; }
 .section h3 { color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-top: 0; }
 .badge { display: inline-block; background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 4px; font-size: 0.9em; margin-right: 8px; }
 </style>
 </head>
 <body>
 <h1>Fiche de synthÃ¨se - Bilan kinÃ©sithÃ©rapique</h1>
 <div class="info-patient">
 <p><strong>Patient :</strong> ${patient.nom} ${patient.prenom}</p>
 <p><strong>Date du bilan :</strong> ${bilanData.date}</p>
 ${bilanData.typeInitial || bilanData.typeIntermediaire || bilanData.typeFinale ? `
 <p><strong>Type de bilan :</strong>
 ${bilanData.typeInitial ? '<span class="badge">Initial</span>' : ''}
 ${bilanData.typeIntermediaire ? '<span class="badge">IntermÃ©diaire</span>' : ''}
 ${bilanData.typeFinale ? '<span class="badge">Final</span>' : ''}
 </p>
 ` : ''}
 </div>
 ${bilanData.diagnostic ? `
 <div class="section">
 <h3>Diagnostic kinÃ©sithÃ©rapique</h3>
 <p>${bilanData.diagnostic.replace(/\n/g, '<br>')}</p>
 </div>
 ` : ''}
 ${bilanData.objectifsCourtTerme || bilanData.objectifsLongTerme ? `
 <div class="section">
 <h3>Objectifs</h3>
 ${bilanData.objectifsCourtTerme ? `<p><strong>Ã€ court terme :</strong><br>${bilanData.objectifsCourtTerme.replace(/\n/g, '<br>')}</p>` : ''}
 ${bilanData.objectifsLongTerme ? `<p><strong>Ã€ moyen/long terme :</strong><br>${bilanData.objectifsLongTerme.replace(/\n/g, '<br>')}</p>` : ''}
 </div>
 ` : ''}
 ${bilanData.nombreSeances || bilanData.techniques ? `
 <div class="section">
 <h3>Protocole thÃ©rapeutique</h3>
 ${bilanData.nombreSeances ? `<p><strong>Nombre de sÃ©ances :</strong> ${bilanData.nombreSeances}</p>` : ''}
 ${bilanData.techniques ? `<p><strong>Techniques :</strong><br>${bilanData.techniques.replace(/\n/g, '<br>')}</p>` : ''}
 </div>
 ` : ''}
 ${bilanData.commentaires ? `
 <div class="section">
 <h3>Commentaires</h3>
 <p>${bilanData.commentaires.replace(/\n/g, '<br>')}</p>
 </div>
 ` : ''}
 </body>
 </html>
 `);
 printWindow.document.close();
 setTimeout(() => {
 printWindow.focus();
 printWindow.print();
 }, 250);
 }
 // CRUD Factures
 function createNewFacture() {
 selectedActes = [];
 currentPatientFilter = null;
 editingItem = null;
 openFactureModal();
 }
 function createFactureForPatient(patientId) {
 const actesPatient = appData.actes.filter(a => a.patientId === patientId && a.statut === 'en_attente');
 if (actesPatient.length === 0) {
 alert('Aucun acte en attente pour ce patient');
 return;
 }
 selectedActes = actesPatient.map(a => a.id);
 openFactureModal(null, patientId);
 }
 function openFactureModal(id = null, patientIdFilter = null) {
 editingItem = id ? appData.factures.find(f => f.id === id) : null;
 
 if (editingItem) {
 selectedActes = [...editingItem.actesSelectionnes];
 }
 
 // Stocker le filtre patient pour le rÃ©utiliser lors du toggle
 // Si currentPatientFilter est dÃ©jÃ  dÃ©fini, on le conserve (c'est un toggle)
 if (patientIdFilter !== null || currentPatientFilter === null) {
 currentPatientFilter = patientIdFilter;
 }
 
 // Filtrer les actes disponibles
 let actesDisponibles = appData.actes.filter(a => a.statut === 'en_attente');
 
 // Si on a un filtre patient (crÃ©ation depuis le bouton patient), ne montrer que ses actes
 if (patientIdFilter) {
 actesDisponibles = actesDisponibles.filter(a => a.patientId === patientIdFilter);
 }
 // Si on modifie une facture existante, dÃ©tecter le patient et ne montrer que ses actes
 else if (editingItem && selectedActes.length > 0) {
 const premierActe = appData.actes.find(a => a.id === selectedActes[0]);
 if (premierActe) {
 const patientId = premierActe.patientId;
 currentPatientFilter = patientId;
 actesDisponibles = actesDisponibles.filter(a => a.patientId === patientId);
 }
 }
 
 const selectedTotal = selectedActes.reduce((sum, acteId) => {
 const acte = appData.actes.find(a => a.id === acteId);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 // GÃ©nÃ©rer automatiquement le numÃ©ro de facture si nouvelle facture
 const numeroAuto = id ? editingItem.numero : generateNumeroFacture();
 
 openModal(
 id ? 'Modifier facture' : 'Nouvelle facture HAD',
 `
 ${!id && selectedActes.length > 0 ? `
 <button class="button button-primary" style="width: 100%; margin-bottom: 1rem;" onclick="downloadFactureHADPreview()">ğŸ“¥ AperÃ§u facture HAD</button>
 ` : ''}
 ${id ? `
 <button class="button button-primary" style="width: 100%; margin-bottom: 1rem;" onclick="downloadFactureHAD(${id})">ğŸ–¨ï¸ Imprimer facture HAD</button>
 ` : ''}
 
 <div class="form-group">
 <label class="form-label">Date *</label>
 <input type="date" id="facture-date" class="form-input" value="${editingItem?.date || getToday()}" required>
 </div>
 <div class="form-group">
 <label class="form-label">NumÃ©ro de facture *</label>
 <input type="text" id="facture-numero" class="form-input" value="${numeroAuto}" required>
 ${!id ? '<p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Le numÃ©ro a Ã©tÃ© gÃ©nÃ©rÃ© automatiquement. Vous pouvez le modifier si besoin.</p>' : ''}
 </div>
 <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
 <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
 <span style="font-weight: 600;">SÃ©lectionner les actes</span>
 <span style="color: #2563eb; font-weight: 600;">${selectedTotal.toFixed(2)}â‚¬</span>
 </div>
 <div class="acte-selector">
 ${actesDisponibles.length === 0 ?
 '<div style="padding: 1rem; text-align: center; color: #6b7280;">Aucun acte en attente</div>' :
 actesDisponibles.map(a => `
 <div class="acte-item ${selectedActes.includes(a.id) ? 'selected' : ''}" onclick="toggleActeSelection(${a.id})">
 <div>
 <div style="font-weight: 500;">${getPatientName(a.patientId)}</div>
 <div style="font-size: 0.875rem; color: #6b7280;">${a.date} - ${a.typeActe}${a.bilan ? ' (Bilan)' : ''}</div>
 </div>
 <div style="display: flex; align-items: center; gap: 0.75rem;">
 <span style="font-weight: 600;">${a.montant.toFixed(2)}â‚¬</span>
 ${selectedActes.includes(a.id) ? '<span style="color: #16a34a;">âœ“</span>' : ''}
 </div>
 </div>
 `).join('')
 }
 </div>
 </div>
 <button class="button button-primary" style="width: 100%; margin-top: 1rem;" onclick="saveFacture()">${id ? 'Modifier' : 'Enregistrer'}</button>
 `
 );
 }
 function toggleActeSelection(acteId) {
 const index = selectedActes.indexOf(acteId);
 if (index > -1) {
 selectedActes.splice(index, 1);
 } else {
 selectedActes.push(acteId);
 }
 openFactureModal(editingItem?.id, currentPatientFilter);
 }
 function toggleActeSelectionForReglement(acteId) {
 const index = selectedActes.indexOf(acteId);
 if (index > -1) {
 selectedActes.splice(index, 1);
 } else {
 selectedActes.push(acteId);
 }
 openReglementModal(editingItem?.id);
 }
 function toggleFactureSelectionForReglement(factureId) {
 const facture = appData.factures.find(f => f.id === factureId);
 if (!facture) return;
 
 // VÃ©rifier si tous les actes de la facture sont dÃ©jÃ  sÃ©lectionnÃ©s
 const tousSÃ©lectionnÃ©s = facture.actesSelectionnes.every(aid => selectedActes.includes(aid));
 
 if (tousSÃ©lectionnÃ©s) {
 // DÃ©sÃ©lectionner tous les actes de cette facture
 selectedActes = selectedActes.filter(aid => !facture.actesSelectionnes.includes(aid));
 } else {
 // Ajouter tous les actes de cette facture
 facture.actesSelectionnes.forEach(aid => {
 if (!selectedActes.includes(aid)) {
 selectedActes.push(aid);
 }
 });
 }
 
 // Calculer le nouveau montant total
 const nouveauMontant = selectedActes.reduce((sum, acteId) => {
 const acte = appData.actes.find(a => a.id === acteId);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 // Mettre Ã  jour le champ montant
 const champMontant = document.getElementById('reglement-montant');
 if (champMontant) {
 champMontant.value = nouveauMontant.toFixed(2);
 }
 
 // Recharger le modal pour actualiser la sÃ©lection visuelle
 openReglementModal(editingItem?.id);
 }
 // Fonction pour sÃ©lectionner/dÃ©sÃ©lectionner un acte individuel
 function toggleActeForReglement(acteId) {
 const index = selectedActes.indexOf(acteId);
 if (index > -1) {
 selectedActes.splice(index, 1);
 } else {
 selectedActes.push(acteId);
 }
 
 // Calculer le nouveau montant total
 const nouveauMontant = selectedActes.reduce((sum, id) => {
 const acte = appData.actes.find(a => a.id === id);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 // Mettre Ã  jour le champ montant
 const champMontant = document.getElementById('reglement-montant');
 if (champMontant) {
 champMontant.value = nouveauMontant.toFixed(2);
 }
 
 // Recharger le modal
 openReglementModal(editingItem?.id);
 }
 // Fonction pour sÃ©lectionner/dÃ©sÃ©lectionner tous les actes d'une facture
 function toggleAllActesFacture(factureId) {
 const facture = appData.factures.find(f => f.id === factureId);
 if (!facture) return;
 
 // RÃ©cupÃ©rer les actes non rÃ©glÃ©s de cette facture
 const actesFacture = appData.actes.filter(a => 
 facture.actesSelectionnes.includes(a.id) && 
 (a.statut === 'facture' || (editingItem && a.reglementId === editingItem.id))
 );
 const actesIds = actesFacture.map(a => a.id);
 
 // VÃ©rifier si tous sont sÃ©lectionnÃ©s
 const tousSÃ©lectionnÃ©s = actesIds.every(aid => selectedActes.includes(aid));
 
 if (tousSÃ©lectionnÃ©s) {
 // DÃ©sÃ©lectionner tous
 selectedActes = selectedActes.filter(aid => !actesIds.includes(aid));
 } else {
 // SÃ©lectionner tous
 actesIds.forEach(aid => {
 if (!selectedActes.includes(aid)) {
 selectedActes.push(aid);
 }
 });
 }
 
 // Calculer le nouveau montant total
 const nouveauMontant = selectedActes.reduce((sum, id) => {
 const acte = appData.actes.find(a => a.id === id);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 // Mettre Ã  jour le champ montant
 const champMontant = document.getElementById('reglement-montant');
 if (champMontant) {
 champMontant.value = nouveauMontant.toFixed(2);
 }
 
 // Recharger le modal
 openReglementModal(editingItem?.id);
 }
 function toggleFacturesReglees() {
 showFacturesReglees = !showFacturesReglees;
 renderCurrentTab();
 }
 function togglePatientsInactifs() {
 showPatientsInactifs = !showPatientsInactifs;
 renderCurrentTab();
 }
 function toggleActesRegles() {
 showActesRegles = !showActesRegles;
 renderCurrentTab();
 }
 function saveFacture() {
 const date = document.getElementById('facture-date').value;
 const numero = document.getElementById('facture-numero').value.trim();
 
 if (!date || !numero || selectedActes.length === 0) {
 alert('Date, numÃ©ro et actes requis');
 return;
 }
 
 const montantTotal = selectedActes.reduce((sum, acteId) => {
 const acte = appData.actes.find(a => a.id === acteId);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 const facture = {
 id: editingItem?.id || generateId(),
 date,
 numero,
 montantTotal,
 actesSelectionnes: [...selectedActes]
 };
 
 // Mise Ã  jour du statut des actes
 appData.actes = appData.actes.map(a => {
 if (selectedActes.includes(a.id)) {
 return { ...a, statut: 'facture', factureId: facture.id };
 }
 if (editingItem && editingItem.actesSelectionnes.includes(a.id) && !selectedActes.includes(a.id)) {
 return { ...a, statut: 'en_attente', factureId: null };
 }
 return a;
 });
 
 if (editingItem) {
 const index = appData.factures.findIndex(f => f.id === editingItem.id);
 appData.factures[index] = facture;
 } else {
 appData.factures.push(facture);
 }
 
 saveData();
 closeModal();
 }
 function editFacture(id) {
 openFactureModal(id);
 }
 function deleteFacture(id) {
 if (!confirm('Supprimer cette facture ? Les actes repasseront en attente.')) return;
 
 const facture = appData.factures.find(f => f.id === id);
 appData.actes = appData.actes.map(a =>
 facture.actesSelectionnes.includes(a.id) ? { ...a, statut: 'en_attente', factureId: null } : a
 );
 appData.factures = appData.factures.filter(f => f.id !== id);
 saveData();
 }
 function downloadFactureHAD(factureId) {
 const facture = appData.factures.find(f => f.id === factureId);
 if (!facture) return;
 
 const actesFacture = appData.actes.filter(a => facture.actesSelectionnes.includes(a.id));
 const patientId = actesFacture[0]?.patientId;
 const patient = appData.patients.find(p => p.id === patientId);
 
 if (!patient) {
 alert('Patient non trouvÃ©');
 return;
 }
 
 // Afficher une modale avec les options
 const emailConfigured = appData.parametres.structure?.email || '';
 
 openModal(
 `Facture HAD nÂ°${facture.numero}`,
 `
 <div style="text-align: center; padding: 1rem;">
 <p style="margin-bottom: 2rem; color: #6b7280;">
 <strong>Patient :</strong> ${patient.nom} ${patient.prenom}<br>
 <strong>Date :</strong> ${facture.date}<br>
 <strong>Montant :</strong> ${facture.montantTotal.toFixed(2)}â‚¬
 </p>
 <div style="display: flex; flex-direction: column; gap: 1rem;">
 <button class="button button-primary" style="width: 100%;" onclick="printFactureComplete(${facture.id}); closeModal();">
 ğŸ–¨ï¸ Imprimer / TÃ©lÃ©charger
 </button>
 <button class="button" style="width: 100%; background: #7c3aed; color: white;" onclick="printFacturePreImprimee(${facture.id}); closeModal();">
 ğŸ“„ Imprimer prÃ©-imprimÃ© CERFA
 </button>
 ${emailConfigured ? `
 <button class="button button-success" style="width: 100%;" onclick="sendFactureByEmail(${facture.id}); closeModal();">
 ğŸ“§ Envoyer par email
 </button>
 ` : `
 <div style="padding: 1rem; background: #fef3c7; border-radius: 0.5rem; text-align: left;">
 <p style="margin: 0; font-size: 0.875rem; color: #78350f;">
 âš ï¸ <strong>Email non configurÃ©</strong><br>
 Pour envoyer par email, configurez l'adresse email de votre structure dans les ParamÃ¨tres.
 </p>
 </div>
 `}
 </div>
 </div>
 `
 );
 }
 function printFactureComplete(factureId) {
 const facture = appData.factures.find(f => f.id === factureId);
 if (!facture) return;
 
 const actesFacture = appData.actes.filter(a => facture.actesSelectionnes.includes(a.id));
 const patientId = actesFacture[0]?.patientId;
 const patient = appData.patients.find(p => p.id === patientId);
 
 if (!patient) {
 alert('Patient non trouvÃ©');
 return;
 }
 
 generateFactureHADHTML(facture, patient, actesFacture);
 }
 function printFacturePreImprimee(factureId) {
 const facture = appData.factures.find(f => f.id === factureId);
 if (!facture) return;
 
 const actesFacture = appData.actes.filter(a => facture.actesSelectionnes.includes(a.id));
 const patientId = actesFacture[0]?.patientId;
 const patient = appData.patients.find(p => p.id === patientId);
 
 if (!patient) {
 alert('Patient non trouvÃ©');
 return;
 }
 
 generateFacturePreImprimee(facture, patient, actesFacture);
 }
 function generateFactureHADHTML(facture, patient, actesFacture) {
 // Trier les actes par date
 const actesTries = [...actesFacture].sort((a, b) => a.date.localeCompare(b.date));
 
 // Calculer les totaux
 const totalActes = actesFacture.reduce((sum, acte) => sum + acte.montant, 0);
 const totalIFD = actesFacture.reduce((sum, acte) => {
 return sum + (acte.indemnite ? (acte.montantIndemnite || 0) : 0);
 }, 0);
 const montantTotal = totalActes + totalIFD;
 
 const htmlContent = `<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>Facture HAD - ${patient.nom} ${patient.prenom}</title>
 <style>
 @media print { @page { size: A4; margin: 1cm; } .no-print { display: none; } }
 body { font-family: Arial; margin: 20px; font-size: 11pt; line-height: 1.4; }
 .no-print { position: fixed; top: 10px; right: 10px; z-index: 1000; }
 .no-print button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
 .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
 .header h1 { margin: 0; font-size: 16pt; color: #2563eb; }
 .section { margin: 15px 0; }
 .section-title { background: #2563eb; color: white; padding: 5px 10px; font-weight: bold; margin-bottom: 10px; }
 .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
 .info-box { border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
 .info-box label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 9pt; color: #555; }
 table { width: 100%; border-collapse: collapse; margin: 10px 0; }
 th, td { border: 1px solid #333; padding: 8px; text-align: left; }
 th { background: #e5e7eb; font-weight: bold; font-size: 10pt; }
 .text-right { text-align: right; }
 .text-center { text-align: center; }
 .total-row { background: #dbeafe; font-weight: bold; }
 .indemnite-row { background: #fef3c7; }
 </style>
</head>
<body>
 <div class="no-print">
 <button onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
 </div>
 <div class="header">
 <h1>FEUILLE DE SOINS - HONORAIRES DU PRATICIEN</h1>
 <p>Facture NÂ° ${facture.numero || '_______'} - Date : ${facture.date}</p>
 </div>
 <div class="section">
 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
 <div>
 <div class="section-title">IDENTIFICATION DU BÃ‰NÃ‰FICIAIRE</div>
 <div style="display: flex; flex-direction: column; gap: 10px;">
 <div class="info-box"><label>Nom - PrÃ©nom :</label><p>${patient.nom} ${patient.prenom}</p></div>
 <div class="info-box"><label>NÂ° SÃ©curitÃ© Sociale :</label><p>${patient.numeroSecu || '___________________________'}</p></div>
 </div>
 </div>
 <div>
 <div class="section-title">IDENTIFICATION DE LA STRUCTURE</div>
 <div style="display: flex; flex-direction: column; gap: 10px;">
 <div class="info-box">
 <p style="margin: 0;">${appData.parametres.structure?.nom || '_________________________________'}</p>
 <p style="margin: 5px 0 0 0;">${appData.parametres.structure?.adresse || '_________________________________'}</p>
 </div>
 <div class="info-box"><label>NÂ° RPPS / ADELI :</label><p>${appData.parametres.structure?.numero || '_________________________________'}</p></div>
 </div>
 </div>
 </div>
 </div>
 <div class="section">
 <div class="section-title">IDENTIFICATION DU PROFESSIONNEL DE SANTÃ‰</div>
 <div class="info-grid">
 <div class="info-box"><label>Nom - PrÃ©nom :</label><p>${appData.parametres.professionnel?.nom && appData.parametres.professionnel?.prenom ? appData.parametres.professionnel.nom + ' ' + appData.parametres.professionnel.prenom : '_________________________________'}</p></div>
 <div class="info-box"><label>NÂ° RPPS / ADELI :</label><p>${appData.parametres.professionnel?.numeroRPPS || '_________________________________'}</p></div>
 </div>
 <div class="info-box"><label>Adresse du cabinet :</label><p>${appData.parametres.professionnel?.adresseCabinet || '_______________________________________________'}</p></div>
 </div>
 <div class="section">
 <div class="section-title">DÃ‰TAIL DES ACTES</div>
 <table>
 <thead>
 <tr>
 <th style="width: 14%">Date</th>
 <th style="width: 14%">Code acte</th>
 <th style="width: 38%">LibellÃ©</th>
 <th style="width: 10%" class="text-center">QtÃ©</th>
 <th style="width: 12%" class="text-right">Prix unit.</th>
 <th style="width: 12%" class="text-right">IFD</th>
 </tr>
 </thead>
 <tbody>
 ${actesTries.map(acte => {
 const typeActeInfo = appData.parametres.typesActes.find(t => t.code === acte.typeActe);
 const libelle = typeActeInfo?.libelle || acte.typeActe;
 const codeActe = acte.bilan ? acte.typeActe + ' (Bilan)' : acte.typeActe;
 const montantIFD = acte.indemnite ? (acte.montantIndemnite || 0) : 0;
 return `
 <tr>
 <td>${acte.date}</td>
 <td>${codeActe}</td>
 <td>${libelle}</td>
 <td class="text-center">1</td>
 <td class="text-right">${acte.montant.toFixed(2)} â‚¬</td>
 <td class="text-right">${montantIFD > 0 ? montantIFD.toFixed(2) + ' â‚¬' : '-'}</td>
 </tr>
 `;
 }).join('')}
 <tr style="height: 20px;">
 <td colspan="6" style="border: none; background: white;"></td>
 </tr>
 <tr>
 <td colspan="6" style="background: #2563eb; color: white; font-weight: bold; padding: 5px 10px;">PAIEMENT</td>
 </tr>
 <tr class="total-row">
 <td colspan="5" class="text-right"><strong>TOTAL Ã€ PAYER :</strong></td>
 <td class="text-right"><strong>${montantTotal.toFixed(2)} â‚¬</strong></td>
 </tr>
 </tbody>
 </table>
 </div>
 <div class="section">
 <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; margin-top: 30px;">
 <div class="info-box" style="min-height: 100px;">
 <label>Signature de l'auxiliaire mÃ©dical</label>
 <p style="margin-top: 50px;"></p>
 </div>
 <div class="info-box" style="min-height: 100px;">
 <label>Signature de l'assurÃ©</label>
 <p style="margin-top: 50px;"></p>
 </div>
 <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
 <div style="text-align: center; font-size: 9pt; font-weight: bold; margin-bottom: 10px; line-height: 1.2;">
 ImpossibilitÃ©<br>de<br>signer
 </div>
 <input type="checkbox" style="width: 20px; height: 20px; cursor: pointer;">
 </div>
 </div>
 </div>
</body>
</html>`;
 
 // Ouvrir une fenÃªtre d'impression
 const printWindow = window.open('', '_blank', 'width=800,height=600');
 if (printWindow) {
 printWindow.document.write(htmlContent);
 printWindow.document.close();
 printWindow.focus();
 } else {
 alert('Veuillez autoriser les fenÃªtres popup pour afficher la facture');
 }
 }
 function sendFactureByEmail(factureId) {
 const facture = appData.factures.find(f => f.id === factureId);
 if (!facture) return;
 
 const emailStructure = appData.parametres.structure?.email || '';
 
 if (!emailStructure) {
 alert('âš ï¸ Veuillez d\'abord configurer l\'adresse email de votre structure dans les ParamÃ¨tres.');
 return;
 }
 
 const actesFacture = appData.actes.filter(a => facture.actesSelectionnes.includes(a.id));
 const montantTotal = actesFacture.reduce((sum, a) => sum + a.montant, 0);
 
 // Calcul indemnitÃ©s
 const indemniteDeplacement = appData.parametres.indemniteDeplacement?.actif && appData.parametres.indemniteDeplacement?.montant 
 ? actesFacture.length * appData.parametres.indemniteDeplacement.montant 
 : 0;
 const totalAvecIndemnites = montantTotal + indemniteDeplacement;
 
 // Construction du corps de l'email
 const nomStructure = appData.parametres.structure?.nom || 'Cabinet de KinÃ©sithÃ©rapie';
 const subject = `Facture HAD nÂ°${facture.numero}`;
 
 let body = `Bonjour,%0D%0A%0D%0A`;
 body += `Veuillez trouver ci-joint la facture HAD nÂ°${facture.numero} du ${facture.date}.%0D%0A%0D%0A`;
 body += `DÃ©tail de la facture :%0D%0A`;
 body += `-------------------%0D%0A`;
 
 actesFacture.forEach(acte => {
 const patient = appData.patients.find(p => p.id === acte.patientId);
 const patientName = patient ? `${patient.nom} ${patient.prenom}` : 'Patient inconnu';
 body += `- ${acte.date} : ${patientName} - ${acte.typeActe}${acte.bilan ? ' (Bilan)' : ''} : ${acte.montant.toFixed(2)}â‚¬%0D%0A`;
 });
 
 if (indemniteDeplacement > 0) {
 body += `%0D%0AIndemnitÃ©s de dÃ©placement : ${indemniteDeplacement.toFixed(2)}â‚¬%0D%0A`;
 }
 
 body += `%0D%0AMONTANT TOTAL : ${totalAvecIndemnites.toFixed(2)}â‚¬%0D%0A%0D%0A`;
 body += `Cordialement,%0D%0A${nomStructure}`;
 
 // CrÃ©ation du lien mailto avec destinataire prÃ©-rempli
 const mailtoLink = `mailto:${emailStructure}?subject=${encodeURIComponent(subject)}&body=${body}`;
 
 // Ouvrir le client email
 window.location.href = mailtoLink;
 }
 // Import et rapprochement de bordereau HAD
 // CRUD RÃ¨glements
 function openReglementModal(id = null) {
 editingItem = id ? appData.reglements.find(r => r.id === id) : null;
 if (editingItem) {
 selectedActes = [...editingItem.actesSelectionnes];
 }
 
 // RÃ©cupÃ©rer les factures qui ont au moins un acte non rÃ©glÃ©
 const facturesDisponibles = appData.factures.filter(f => {
 const actesFacture = appData.actes.filter(a => f.actesSelectionnes.includes(a.id));
 // Une facture est disponible si elle a au moins un acte en statut 'facture' ou si elle est en cours d'Ã©dition
 return actesFacture.some(a => a.statut === 'facture' || (editingItem && a.reglementId === editingItem.id));
 });
 
 const selectedTotal = selectedActes.reduce((sum, acteId) => {
 const acte = appData.actes.find(a => a.id === acteId);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 openModal(
 id ? 'Modifier rÃ¨glement' : 'Nouveau rÃ¨glement HAD',
 `
 <div class="form-group">
 <label class="form-label">Date *</label>
 <input type="date" id="reglement-date" class="form-input" value="${editingItem?.date || getToday()}" required>
 </div>
 <div class="form-group">
 <label class="form-label">PÃ©riode (ex: Janvier 2025) *</label>
 <input type="text" id="reglement-periode" class="form-input" value="${editingItem?.periode || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">Montant total HAD *</label>
 <input type="number" step="0.01" id="reglement-montant" class="form-input" value="${selectedTotal.toFixed(2)}" required>
 <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">ğŸ’¡ Le montant se met Ã  jour automatiquement selon les actes sÃ©lectionnÃ©s</p>
 </div>
 <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
 <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
 <span style="font-weight: 600;">SÃ©lectionner les actes rÃ©glÃ©s</span>
 <span style="font-weight: 600; color: ${selectedTotal > 0 ? '#16a34a' : '#f97316'};">${selectedTotal.toFixed(2)}â‚¬</span>
 </div>
 <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">
 ğŸ’¡ Vous pouvez sÃ©lectionner individuellement les actes rÃ©glÃ©s pour gÃ©rer les paiements partiels
 </div>
 <div class="acte-selector" id="factures-selector">
 ${facturesDisponibles.length === 0 ?
 '<div style="padding: 1rem; text-align: center; color: #6b7280;">Aucune facture disponible</div>' :
 facturesDisponibles.map(f => {
 const actesFacture = appData.actes.filter(a => f.actesSelectionnes.includes(a.id));
 const actesNonRegles = actesFacture.filter(a => a.statut === 'facture' || (editingItem && a.reglementId === editingItem.id));
 
 if (actesNonRegles.length === 0) return ''; // Ne pas afficher si tous les actes sont rÃ©glÃ©s
 
 const patient = appData.patients.find(p => p.id === actesFacture[0]?.patientId);
 const patientName = patient ? `${patient.nom} ${patient.prenom}` : 'Patient inconnu';
 const actesReglesCount = actesFacture.filter(a => selectedActes.includes(a.id)).length;
 const tousActesNonRegles = actesNonRegles.every(a => selectedActes.includes(a.id));
 
 return `
 <div class="acte-item ${tousActesNonRegles ? 'selected' : ''}" style="display: block; cursor: default; padding: 0.75rem;">
 <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
 <div>
 <div style="font-weight: 600; color: #1f2937;">Facture ${f.numero} - ${patientName}</div>
 <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
 ${f.date} - ${actesReglesCount}/${actesNonRegles.length} acte(s) sÃ©lectionnÃ©(s)
 </div>
 </div>
 <button class="button" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" onclick="toggleAllActesFacture(${f.id}); event.stopPropagation();">
 ${tousActesNonRegles ? 'â˜ Tout dÃ©sÃ©lectionner' : 'â˜‘ Tout sÃ©lectionner'}
 </button>
 </div>
 <div style="margin-left: 1rem; border-left: 2px solid #e5e7eb; padding-left: 0.75rem;">
 ${actesNonRegles.map(acte => {
 const isSelected = selectedActes.includes(acte.id);
 const montantActe = getActeMontantTotal(acte);
 const typeActeInfo = appData.parametres.typesActes.find(t => t.code === acte.typeActe);
 const codeActe = typeActeInfo ? typeActeInfo.code : acte.typeActe;
 
 return `
 <div class="acte-item ${isSelected ? 'selected' : ''}" onclick="toggleActeForReglement(${acte.id})" style="margin: 0.25rem 0; padding: 0.5rem; cursor: pointer;">
 <div style="display: flex; justify-content: space-between; align-items: center;">
 <div>
 <span style="font-weight: 500;">${acte.date}</span>
 <span style="color: #6b7280; margin-left: 0.5rem;">${codeActe}</span>
 </div>
 <div style="display: flex; align-items: center; gap: 0.75rem;">
 <span style="font-weight: 600;">${montantActe.toFixed(2)}â‚¬</span>
 ${isSelected ? '<span style="color: #16a34a;">âœ“</span>' : '<span style="color: #d1d5db;">â—‹</span>'}
 </div>
 </div>
 </div>
 `;
 }).join('')}
 </div>
 </div>
 `;
 }).join('')
 }
 </div>
 </div>
 <button class="button button-primary" style="width: 100%; margin-top: 1rem;" onclick="saveReglement()">${id ? 'Modifier' : 'Enregistrer'}</button>
 `
 );
 }
 function saveReglement() {
 const date = document.getElementById('reglement-date').value;
 const periode = document.getElementById('reglement-periode').value.trim();
 const montantTotal = parseFloat(document.getElementById('reglement-montant').value);
 
 if (!date || !periode || !montantTotal) {
 alert('Tous les champs sont requis');
 return;
 }
 
 if (selectedActes.length === 0) {
 alert('Veuillez sÃ©lectionner au moins un acte Ã  rÃ©gler');
 return;
 }
 
 const montantSelectionne = selectedActes.reduce((sum, acteId) => {
 const acte = appData.actes.find(a => a.id === acteId);
 return sum + (acte ? getActeMontantTotal(acte) : 0);
 }, 0);
 
 // VÃ©rification : le montant HAD ne doit pas Ãªtre supÃ©rieur au montant sÃ©lectionnÃ©
 if (montantTotal > montantSelectionne + 0.01) {
 alert(`Le montant HAD (${montantTotal.toFixed(2)}â‚¬) ne peut pas Ãªtre supÃ©rieur au montant des actes sÃ©lectionnÃ©s (${montantSelectionne.toFixed(2)}â‚¬)`);
 return;
 }
 
 // Avertissement si paiement partiel
 if (Math.abs(montantTotal - montantSelectionne) > 0.01) {
 if (!confirm(`âš ï¸ Paiement partiel dÃ©tectÃ©\n\nActes sÃ©lectionnÃ©s : ${montantSelectionne.toFixed(2)}â‚¬\nMontant HAD : ${montantTotal.toFixed(2)}â‚¬\n\nLes actes sÃ©lectionnÃ©s seront marquÃ©s comme rÃ©glÃ©s mais la facture restera disponible pour les actes non rÃ©glÃ©s.\n\nContinuer ?`)) {
 return;
 }
 }
 
 const reglement = {
 id: editingItem?.id || generateId(),
 date,
 periode,
 montantTotal,
 actesSelectionnes: [...selectedActes]
 };
 
 // Mise Ã  jour du statut des actes
 appData.actes = appData.actes.map(a => {
 if (selectedActes.includes(a.id)) {
 return { ...a, statut: 'regle', reglementId: reglement.id };
 }
 if (editingItem && editingItem.actesSelectionnes.includes(a.id) && !selectedActes.includes(a.id)) {
 return { ...a, statut: 'facture', reglementId: null };
 }
 return a;
 });
 
 if (editingItem) {
 const index = appData.reglements.findIndex(r => r.id === editingItem.id);
 appData.reglements[index] = reglement;
 } else {
 appData.reglements.push(reglement);
 }
 
 saveData();
 closeModal();
 }
 function editReglement(id) {
 openReglementModal(id);
 }
 function deleteReglement(id) {
 if (!confirm('Supprimer ? Les actes repasseront en statut facturÃ©.')) return;
 
 const reglement = appData.reglements.find(r => r.id === id);
 appData.actes = appData.actes.map(a =>
 reglement.actesSelectionnes.includes(a.id) ? { ...a, statut: 'facture', reglementId: null } : a
 );
 appData.reglements = appData.reglements.filter(r => r.id !== id);
 saveData();
 }
 function viewReglementDetails(id) {
 const reglement = appData.reglements.find(r => r.id === id);
 if (!reglement) return;
 
 const actesReglement = appData.actes.filter(a => reglement.actesSelectionnes.includes(a.id));
 
 const detailHTML = `
 <div class="section-box" style="margin-bottom: 1rem;">
 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
 <div>
 <label style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Date du rÃ¨glement</label>
 <p style="margin: 0.25rem 0 0 0; font-size: 1rem;">${reglement.date}</p>
 </div>
 <div>
 <label style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">PÃ©riode</label>
 <p style="margin: 0.25rem 0 0 0; font-size: 1rem;">${reglement.periode}</p>
 </div>
 </div>
 <div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
 <label style="font-weight: 600; color: #6b7280; font-size: 0.875rem;">Montant total</label>
 <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: bold; color: #16a34a;">${reglement.montantTotal.toFixed(2)} â‚¬</p>
 </div>
 </div>
 <div style="margin-top: 1.5rem;">
 <h4 style="margin-bottom: 0.75rem; color: #374151;">Actes rÃ©glÃ©s (${actesReglement.length})</h4>
 <table style="width: 100%; border-collapse: collapse;">
 <thead>
 <tr style="background: #f9fafb;">
 <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Date</th>
 <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Patient</th>
 <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Type</th>
 <th style="padding: 0.5rem; text-align: right; border: 1px solid #e5e7eb;">Montant</th>
 </tr>
 </thead>
 <tbody>
 ${actesReglement.map(a => `
 <tr>
 <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${a.date}</td>
 <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${getPatientName(a.patientId)}</td>
 <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">${a.typeActe}${a.bilan ? ' (Bilan)' : ''}</td>
 <td style="padding: 0.5rem; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">${a.montant.toFixed(2)} â‚¬</td>
 </tr>
 `).join('')}
 </tbody>
 </table>
 </div>
 `;
 
 openModal('DÃ©tail du rÃ¨glement', detailHTML);
 }
 // CRUD DÃ©penses
 function openDepenseModal(id = null) {
 editingItem = id ? appData.depenses.find(d => d.id === id) : null;
 
 openModal(
 id ? 'Modifier dÃ©pense' : 'Nouvelle dÃ©pense',
 `
 <div class="form-group">
 <label class="form-label">Date *</label>
 <input type="date" id="depense-date" class="form-input" value="${editingItem?.date || getToday()}" required>
 </div>
 <div class="form-group">
 <label class="form-label">CatÃ©gorie *</label>
 <select id="depense-categorie" class="form-select" required>
 ${categoriesDepenses.map(cat => `<option value="${cat.value}" ${editingItem?.categorie === cat.value ? 'selected' : ''}>${cat.label}</option>`).join('')}
 </select>
 </div>
 <div class="form-group">
 <label class="form-label">Description *</label>
 <input type="text" id="depense-description" class="form-input" value="${editingItem?.description || ''}" required>
 </div>
 <div class="form-group">
 <label class="form-label">Montant *</label>
 <input type="number" step="0.01" id="depense-montant" class="form-input" value="${editingItem?.montant || ''}" required>
 </div>
 <button class="button button-primary" style="width: 100%;" onclick="saveDepense()">${id ? 'Modifier' : 'Enregistrer'}</button>
 `
 );
 }
 function saveDepense() {
 const date = document.getElementById('depense-date').value;
 const categorie = document.getElementById('depense-categorie').value;
 const description = document.getElementById('depense-description').value.trim();
 const montant = parseFloat(document.getElementById('depense-montant').value);
 
 if (!date || !categorie || !description || !montant) {
 alert('Tous les champs sont requis');
 return;
 }
 
 const depense = {
 id: editingItem?.id || generateId(),
 date,
 categorie,
 description,
 montant
 };
 
 if (editingItem) {
 const index = appData.depenses.findIndex(d => d.id === editingItem.id);
 appData.depenses[index] = depense;
 } else {
 appData.depenses.push(depense);
 }
 
 saveData();
 closeModal();
 }
 function editDepense(id) {
 openDepenseModal(id);
 }
 function deleteDepense(id) {
 if (!confirm('Supprimer cette dÃ©pense ?')) return;
 appData.depenses = appData.depenses.filter(d => d.id !== id);
 saveData();
 }
 // Export / Import
 function exportBackup() {
 const backup = { ...appData, date: new Date().toISOString() };
 const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 const dateStr = new Date().toISOString().split('T')[0];
 a.download = `sauvegarde_kine_${dateStr}.json`;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 URL.revokeObjectURL(url);
 }
 function importBackup(event) {
 const file = event.target.files[0];
 if (!file) return;
 
 const reader = new FileReader();
 reader.onload = function(e) {
 try {
 const backup = JSON.parse(e.target.result);
 if (confirm('Remplacer toutes vos donnÃ©es actuelles ?')) {
 appData = {
 patients: backup.patients || [],
 actes: backup.actes || [],
 bilans: backup.bilans || [],
 factures: backup.factures || [],
 reglements: backup.reglements || [],
 depenses: backup.depenses || [],
 parametres: backup.parametres || {
 typesActes: [
 { code: 'AMK', libelle: 'Massage / Mobilisation', montant: 16.13 },
 { code: 'AMS', libelle: 'RÃ©Ã©ducation spÃ©cialisÃ©e', montant: 23.10 },
 { code: 'AMC', libelle: 'Consultation', montant: 30.00 }
 ],
 indemniteDeplacement: {
 actif: true,
 montant: 2.50
 },
 structure: {
 nom: '',
 adresse: '',
 numero: '',
 email: ''
 },
 professionnel: {
 nom: '',
 prenom: '',
 numeroRPPS: '',
 adresseCabinet: ''
 }
 }
 };
 saveData();
 alert('Sauvegarde restaurÃ©e avec succÃ¨s !');
 }
 } catch (error) {
 alert('Erreur lors de la lecture du fichier');
 }
 };
 reader.readAsText(file);
 }
 // GÃ©nÃ©ration facture pour formulaire prÃ©-imprimÃ© CERFA
 function generateFacturePreImprimee(facture, patient, actesFacture) {
 // Format A4 : 210mm x 297mm
 // Police : 6mm de hauteur (environ 17pt Ã  72dpi, mais nous utilisons 18pt pour Ãªtre sÃ»r)
 
 // Fonction pour formater la date au format JJ/MM/AAAA
 const formatDate = (dateStr) => {
 const [year, month, day] = dateStr.split('-');
 return `${day}/${month}/${year}`;
 };
 
 const htmlContent = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Facture CERFA - ${facture.numero}</title>
<style>
@page {
 size: A4;
 margin: 0;
}
body {
 margin: 0;
 padding: 0;
 font-family: 'Courier New', monospace;
 font-size: 14pt;
 line-height: 1;
}
.cerfa-page {
 position: relative;
 width: 210mm;
 height: 297mm;
 page-break-after: always;
}
.field {
 position: absolute;
 font-size: 14pt;
 font-weight: bold;
 color: #000;
}
.checkbox {
 position: absolute;
 font-size: 20pt;
 font-weight: bold;
 color: #000;
}
</style>
</head>
<body>
<div class="cerfa-page">
 
 <!-- NumÃ©ro de facture (en haut Ã  droite) -->
 <div class="field" style="top: 8mm; left: 157mm;">${facture.numero}</div>
 
 <!-- Date de la facture (format JJ MM AAAA espacÃ©) -->
 <div class="field" style="top: 17mm; left: 165mm;">${formatDate(facture.date).replace(/\//g, ' ')}</div>
 
 <!-- Nom et prÃ©nom du patient -->
 <div class="field" style="top: 29mm; left: 15mm;">${patient.nom.toUpperCase()} ${patient.prenom.toUpperCase()}</div>
 
 <!-- Case Ã  cocher MALADIE -->
 <div class="checkbox" style="top: 141mm; left: 8mm;">X</div>
 
 <!-- Tableau des actes (6 lignes maximum) -->
 ${actesFacture.slice(0, 6).map((acte, index) => {
 const yPos = 197 + (index * 8.3); // 197mm de base (194 + 3) + 8.3mm par ligne
 const typeActeInfo = appData.parametres.typesActes.find(t => t.code === acte.typeActe);
 const tarification = typeActeInfo ? typeActeInfo.code : acte.typeActe;
 
 return `
 <!-- Acte ` + (index + 1) + ` -->
 <!-- Date de l'acte -->
 <div class="field" style="top: ` + yPos + `mm; left: 6mm;">` + formatDate(acte.date).replace(/\//g, ' ') + `</div>
 
 <!-- Tarification (code) -->
 <div class="field" style="top: ` + yPos + `mm; left: 74mm;">` + tarification + `</div>
 
 <!-- Montant des honoraires -->
 <div class="field" style="top: ` + yPos + `mm; left: 123mm;">` + acte.montant.toFixed(2) + `</div>
 
 <!-- IFD (IndemnitÃ© Forfaitaire de DÃ©placement) - partie entiÃ¨re uniquement -->
 <div class="field" style="top: ` + yPos + `mm; left: 150mm;">` + Math.floor(acte.indemnite ? (acte.montantIndemnite || 0) : 0) + `</div>
 `;
 }).join('')}
 
 <!-- Montant total -->
 <div class="field" style="top: 250mm; left: 111mm; font-size: 16pt;">${facture.montantTotal.toFixed(2)}</div>
 
 <!-- Case "impossibilitÃ© de signer" -->
 <div class="checkbox" style="top: 271mm; left: 190mm;">X</div>
 
</div>

<script>
// Impression automatique au chargement
window.onload = function() {
 setTimeout(function() {
 window.print();
 }, 500);
};
<\/script>
</body>
</html>`;
 
 // Ouvrir dans une nouvelle fenÃªtre pour impression
 const printWindow = window.open('', '_blank', 'width=800,height=600');
 if (printWindow) {
 printWindow.document.write(htmlContent);
 printWindow.document.close();
 } else {
 alert('Veuillez autoriser les fenÃªtres popup pour imprimer le formulaire');
 }
 }
 // Export / Import
 function exportCSV(type) {
 let csv = '';
 let filename = '';
 
 if (type === 'actes') {
 csv = 'Date,Patient,Type,Bilan,Montant,Statut\n';
 appData.actes.forEach(a => {
 const statutLabel = a.statut === 'regle' ? 'RÃ©glÃ©' : a.statut === 'facture' ? 'FacturÃ©' : 'En attente';
 csv += `${a.date},"${getPatientName(a.patientId)}",${a.typeActe},${a.bilan ? 'Oui' : 'Non'},${a.montant},${statutLabel}\n`;
 });
 filename = 'actes.csv';
 } else if (type === 'factures') {
 csv = 'Date,NumÃ©ro,Montant,Actes\n';
 appData.factures.forEach(f => {
 csv += `${f.date},${f.numero},${f.montantTotal},${f.actesSelectionnes.length}\n`;
 });
 filename = 'factures.csv';
 } else if (type === 'reglements') {
 csv = 'Date,PÃ©riode,Montant,Actes\n';
 appData.reglements.forEach(r => {
 csv += `${r.date},"${r.periode}",${r.montantTotal},${r.actesSelectionnes.length}\n`;
 });
 filename = 'reglements.csv';
 } else if (type === '2035') {
 const totalRecettes = appData.reglements.reduce((s, r) => s + r.montantTotal, 0);
 const totalDepenses = appData.depenses.reduce((s, d) => s + d.montant, 0);
 csv = `Recettes,${totalRecettes.toFixed(2)}\nDÃ©penses,${totalDepenses.toFixed(2)}\nBÃ©nÃ©fice,${(totalRecettes - totalDepenses).toFixed(2)}`;
 filename = '2035.csv';
 } else if (type === 'pamc') {
 // Calculs PAMC pour export
 const totalRecettes = appData.reglements.reduce((s, r) => s + r.montantTotal, 0);
 const ventilationDepenses = {};
 categoriesDepenses.forEach(cat => {
 ventilationDepenses[cat.value] = 0;
 });
 appData.depenses.forEach(d => {
 if (ventilationDepenses[d.categorie] !== undefined) {
 ventilationDepenses[d.categorie] += d.montant;
 }
 });
 
 const fraisVehicule = ventilationDepenses['vehicule'] || 0;
 const local = ventilationDepenses['local'] || 0;
 const fournitures = ventilationDepenses['fournitures'] || 0;
 const assurances = ventilationDepenses['assurances'] || 0;
 const formation = ventilationDepenses['formation'] || 0;
 const cotisationsSociales = ventilationDepenses['cotisations'] || 0;
 const honoraires = ventilationDepenses['honoraires'] || 0;
 const telephone = ventilationDepenses['telephone'] || 0;
 const petitEquipement = ventilationDepenses['petit_equipement'] || 0;
 const blanchissage = ventilationDepenses['blanchissage'] || 0;
 const autres = ventilationDepenses['autres'] || 0;
 
 const totalFraisPro = fraisVehicule + local + fournitures + assurances + formation + 
 honoraires + telephone + petitEquipement + blanchissage + autres;
 const beneficeAvantCotisations = totalRecettes - totalFraisPro;
 const beneficeNet = beneficeAvantCotisations - cotisationsSociales;
 const cotisationsFacultatives = 0;
 const revenuFiscal = beneficeNet - cotisationsFacultatives;
 
 csv = 'Code,LibellÃ©,Montant\n';
 csv += `DSCS,Recettes brutes totales,${totalRecettes.toFixed(2)}\n`;
 csv += `DSAV,Honoraires tirÃ©s d'actes conventionnÃ©s,${totalRecettes.toFixed(2)}\n`;
 csv += `DSAW,DÃ©passements d'honoraires,0.00\n`;
 csv += `,,\n`;
 csv += `DSCA,Cotisations sociales obligatoires dÃ©duites,${cotisationsSociales.toFixed(2)}\n`;
 csv += `DSDA,Cotisations sociales nÃ©gatives,0.00\n`;
 csv += `DSEA,Cotisations facultatives,${cotisationsFacultatives.toFixed(2)}\n`;
 csv += `DSAR,Cotisations facultatives activitÃ© conventionnÃ©e,${cotisationsFacultatives.toFixed(2)}\n`;
 csv += `,,\n`;
 csv += `DSGA,Revenus nets activitÃ© conventionnÃ©e (BÃ©nÃ©fice),${beneficeNet.toFixed(2)}\n`;
 csv += `DSHA,Revenus nets activitÃ© conventionnÃ©e (DÃ©ficit),0.00\n`;
 csv += `,,\n`;
 csv += `5QC,Revenu fiscal - BÃ©nÃ©fice ou DÃ©ficit (2042 C PRO),${revenuFiscal.toFixed(2)}\n`;
 csv += `5QB,Revenus exonÃ©rÃ©s,0.00\n`;
 csv += `,,\n`;
 csv += `--- DÃ©tail des charges ---,,\n`;
 csv += `Frais de vÃ©hicule,${fraisVehicule.toFixed(2)}\n`;
 csv += `Loyer et charges locales,${local.toFixed(2)}\n`;
 csv += `Fournitures et documentation,${fournitures.toFixed(2)}\n`;
 csv += `Assurances professionnelles,${assurances.toFixed(2)}\n`;
 csv += `Formation continue,${formation.toFixed(2)}\n`;
 csv += `Honoraires comptables,${honoraires.toFixed(2)}\n`;
 csv += `TÃ©lÃ©phone et Internet,${telephone.toFixed(2)}\n`;
 csv += `Petit Ã©quipement,${petitEquipement.toFixed(2)}\n`;
 csv += `Blanchissage,${blanchissage.toFixed(2)}\n`;
 csv += `Autres frais,${autres.toFixed(2)}\n`;
 csv += `Total frais professionnels,${totalFraisPro.toFixed(2)}\n`;
 filename = 'declaration-pamc.csv';
 }
 
 const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = filename;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 URL.revokeObjectURL(url);
 }
 
 
 // ===== SYNCHRONISATION ONEDRIVE =====
 
 /**
 * Importer les actes depuis fichier JSON mobile
 */
 function importActesMobile() {
 const input = document.createElement('input');
 input.type = 'file';
 input.accept = '.json';
 
 input.onchange = function(e) {
 const file = e.target.files[0];
 if (!file) return;
 
 const reader = new FileReader();
 reader.onload = function(event) {
 try {
 const data = JSON.parse(event.target.result);
 
 // VÃ©rifier format
 if (!data.actes || !Array.isArray(data.actes)) {
 alert('âŒ Format de fichier invalide.\n\nAssurez-vous d\'importer un fichier actes-mobile-*.json');
 return;
 }
 
 let importCount = 0;
 let updateCount = 0;
 
 data.actes.forEach(acte => {
 // VÃ©rifier si l'acte existe dÃ©jÃ 
 const existingIndex = appData.actes.findIndex(a => a.id === acte.id);
 
 if (existingIndex >= 0) {
 // Mettre Ã  jour acte existant
 appData.actes[existingIndex] = acte;
 updateCount++;
 } else {
 // Nouvel acte
 appData.actes.push(acte);
 importCount++;
 }
 });
 
 // Sauvegarder
 saveData();
 updateStatistiques();
 
 // Message de confirmation
 let message = 'âœ… Synchronisation rÃ©ussie !\n\n';
 if (importCount > 0) message += `${importCount} nouvel(s) acte(s)\n`;
 if (updateCount > 0) message += `${updateCount} acte(s) mis Ã  jour\n`;
 message += `\nDate export mobile : ${new Date(data.exportDate).toLocaleString('fr-FR')}`;
 
 alert(message);
 
 // RafraÃ®chir affichage
 switchTab('actes');
 
 } catch (error) {
 console.error('Erreur import:', error);
 alert('âŒ Erreur lors de l\'import :\n\n' + error.message + '\n\nVÃ©rifiez que le fichier est bien un JSON valide.');
 }
 };
 reader.readAsText(file);
 };
 
 input.click();
 }
 
 /**
 * Exporter la liste des patients pour l'app mobile
 */
 function exportPatientsForMobile() {
 // PrÃ©parer donnÃ©es patients
 const patientsActifs = appData.patients.filter(p => p.actif !== false);
 
 if (patientsActifs.length === 0) {
 alert('âš ï¸ Aucun patient actif Ã  exporter.\n\nCrÃ©ez d\'abord des patients dans l\'onglet "Patients".');
 return;
 }
 
 const exportData = {
 version: '1.0',
 exportDate: new Date().toISOString(),
 device: 'pc',
 patients: patientsActifs.map(p => ({
 id: p.id,
 nom: p.nom,
 prenom: p.prenom,
 telephone: p.telephone || '',
 numeroSecuriteSociale: p.numeroSecuriteSociale || '',
 dateNaissance: p.dateNaissance || '',
 adresse: p.adresse || '',
 actif: true
 }))
 };
 
 // CrÃ©er fichier JSON
 const json = JSON.stringify(exportData, null, 2);
 const blob = new Blob([json], { type: 'application/json' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `patients-pc-${new Date().toISOString().split('T')[0]}.json`;
 a.click();
 URL.revokeObjectURL(url);
 
 // Message
 alert(`âœ… Export rÃ©ussi !\n\n${exportData.patients.length} patient(s) exportÃ©(s)\n\nğŸ“¤ Prochaines Ã©tapes :\n1. Uploadez ce fichier dans OneDrive/Kine/PC\n2. Sur mobile, tÃ©lÃ©chargez-le\n3. Onglet Sync â†’ Importez patients`);
 }
 
 
 // Fonction helper pour ouvrir le service OCR avec instructions
 
 // Initialisation
 window.onload = function() {
 loadData();
 };
 </script>
</body>
</html>
